<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Redis 不同架构搭建实践指南 - Guixian 的日常记录</title>
<meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="Chen Guixian"><meta name=description content="本文介绍了Redis在不同系统环境下的安装配置方法，包括Ubuntu/Debian、CentOS/RHEL和macOS系统，并提供了安装验证脚本。详细讲解了主从复制架构的搭建步骤，包含1个主节点和2个从节点的配置示例（端口、持久化、日志、安全等设置）。同时提供了版本兼容性检查脚本，支持Redis 4.x和5.0+版本。所有配置文件和脚本都存放在~/redis-practice目录下，便于实践Redis的各种架构模式（主从复制、集群、哨兵）。"><meta name=keywords content="程序员的日常记录,编码人生,生活笔记"><meta name=generator content="Hugo 0.134.3 with theme even"><link rel=canonical href=https://blog.chenguixian.com/post/op/redis-setup-guide/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.da774276428e8a6854e28c9290a6dfdbe7a5a343455f0a76358a2f66d0a56366.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:url" content="https://blog.chenguixian.com/post/op/redis-setup-guide/"><meta property="og:site_name" content="Guixian 的日常记录"><meta property="og:title" content="Redis 不同架构搭建实践指南"><meta property="og:description" content="本文介绍了Redis在不同系统环境下的安装配置方法，包括Ubuntu/Debian、CentOS/RHEL和macOS系统，并提供了安装验证脚本。详细讲解了主从复制架构的搭建步骤，包含1个主节点和2个从节点的配置示例（端口、持久化、日志、安全等设置）。同时提供了版本兼容性检查脚本，支持Redis 4.x和5.0+版本。所有配置文件和脚本都存放在~/redis-practice目录下，便于实践Redis的各种架构模式（主从复制、集群、哨兵）。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-09-20T21:31:26+08:00"><meta property="article:modified_time" content="2025-09-20T21:31:26+08:00"><meta property="article:tag" content="Redis"><meta itemprop=name content="Redis 不同架构搭建实践指南"><meta itemprop=description content="本文介绍了Redis在不同系统环境下的安装配置方法，包括Ubuntu/Debian、CentOS/RHEL和macOS系统，并提供了安装验证脚本。详细讲解了主从复制架构的搭建步骤，包含1个主节点和2个从节点的配置示例（端口、持久化、日志、安全等设置）。同时提供了版本兼容性检查脚本，支持Redis 4.x和5.0+版本。所有配置文件和脚本都存放在~/redis-practice目录下，便于实践Redis的各种架构模式（主从复制、集群、哨兵）。"><meta itemprop=datePublished content="2025-09-20T21:31:26+08:00"><meta itemprop=dateModified content="2025-09-20T21:31:26+08:00"><meta itemprop=wordCount content="12376"><meta itemprop=keywords content="Redis"><meta name=twitter:card content="summary"><meta name=twitter:title content="Redis 不同架构搭建实践指南"><meta name=twitter:description content="本文介绍了Redis在不同系统环境下的安装配置方法，包括Ubuntu/Debian、CentOS/RHEL和macOS系统，并提供了安装验证脚本。详细讲解了主从复制架构的搭建步骤，包含1个主节点和2个从节点的配置示例（端口、持久化、日志、安全等设置）。同时提供了版本兼容性检查脚本，支持Redis 4.x和5.0+版本。所有配置文件和脚本都存放在~/redis-practice目录下，便于实践Redis的各种架构模式（主从复制、集群、哨兵）。"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Guixian 的日常记录</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Guixian 的日常记录</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Redis 不同架构搭建实践指南</h1><div class=post-meta><span class=post-time>2025-09-20</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#1-环境准备>1 环境准备</a><ul><li><a href=#11-系统要求>1.1 系统要求</a></li><li><a href=#12-安装-redis>1.2 安装 Redis</a></li><li><a href=#13-redis-安装验证和故障排除>1.3 Redis 安装验证和故障排除</a></li><li><a href=#14-创建工作目录>1.4 创建工作目录</a></li><li><a href=#15-redis-版本兼容性检查>1.5 Redis 版本兼容性检查</a></li></ul></li><li><a href=#2-主从复制架构-master-slave>2 主从复制架构 (Master-Slave)</a><ul><li><a href=#21-架构说明>2.1 架构说明</a></li><li><a href=#22-配置文件准备>2.2 配置文件准备</a></li><li><a href=#23-关键命令详解>2.3 关键命令详解</a></li><li><a href=#24-验证主从复制>2.4 验证主从复制</a></li><li><a href=#25-测试读写分离>2.5 测试读写分离</a></li></ul></li><li><a href=#3-redis-cluster-集群架构>3 Redis Cluster 集群架构</a><ul><li><a href=#31-redis-cluster-核心命令详解>3.1 Redis Cluster 核心命令详解</a></li><li><a href=#32-集群节点配置>3.2 集群节点配置</a></li><li><a href=#33-启动集群节点>3.3 启动集群节点</a></li><li><a href=#34-创建集群>3.4 创建集群</a></li><li><a href=#35-验证集群状态>3.5 验证集群状态</a></li><li><a href=#36-集群管理操作>3.6 集群管理操作</a></li></ul></li><li><a href=#4-redis-sentinel-哨兵架构>4 Redis Sentinel 哨兵架构</a><ul><li><a href=#41-redis-sentinel-核心命令详解>4.1 Redis Sentinel 核心命令详解</a></li><li><a href=#42-架构说明>4.2 架构说明</a></li><li><a href=#43-启动-sentinel-架构>4.3 启动 Sentinel 架构</a></li><li><a href=#44-验证-sentinel-功能>4.4 验证 Sentinel 功能</a></li></ul></li><li><a href=#5-监控和管理工具>5 监控和管理工具</a><ul><li><a href=#51-redis-核心监控命令详解>5.1 Redis 核心监控命令详解</a></li><li><a href=#52-redis-监控脚本>5.2 Redis 监控脚本</a></li><li><a href=#53-清理脚本>5.3 清理脚本</a></li></ul></li><li><a href=#6-性能测试>6 性能测试</a><ul><li><a href=#61-redis-性能测试核心命令>6.1 Redis 性能测试核心命令</a></li><li><a href=#62-基准测试脚本>6.2 基准测试脚本</a></li></ul></li><li><a href=#7-快速操作命令总结>7 快速操作命令总结</a><ul><li><a href=#71-核心命令速查表>7.1 核心命令速查表</a></li><li><a href=#72-实用命令速查手册>7.2 实用命令速查手册</a></li></ul></li><li><a href=#8-学习要点和最佳实践>8 学习要点和最佳实践</a><ul><li><a href=#81-主从复制架构>8.1 主从复制架构</a></li><li><a href=#82-cluster-集群架构>8.2 Cluster 集群架构</a></li><li><a href=#83-sentinel-哨兵架构>8.3 Sentinel 哨兵架构</a></li><li><a href=#84-配置要点>8.4 配置要点</a></li><li><a href=#85-常见问题解决方案>8.5 常见问题解决方案</a></li><li><a href=#86-监控指标>8.6 监控指标</a></li></ul></li></ul></li></ul></nav></div></div><div class=post-content><p>本文介绍Redis在不同系统环境下的安装配置方法，并提供了安装验证脚本。详细讲解了主从复制架构的搭建步骤，包含1个主节点和2个从节点的配置示例（端口、持久化、日志、安全等设置）。同时提供了版本兼容性检查脚本，支持Redis 4.x和5.0+版本。所有配置文件和脚本都存放在~/redis-practice目录下，便于实践Redis的各种架构模式（主从复制、集群、哨兵）。</p><h2 id=1-环境准备>1 环境准备</h2><h3 id=11-系统要求>1.1 系统要求</h3><ul><li>操作系统：Linux (推荐 Ubuntu 20.04+ 或 CentOS 7+)</li><li>内存：至少 2GB</li><li>Redis 版本：6.x 或 7.x</li></ul><h3 id=12-安装-redis>1.2 安装 Redis</h3><h4 id=ubuntudebian-系统>Ubuntu/Debian 系统</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 更新包管理器</span>
</span></span><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装 Redis</span>
</span></span><span class=line><span class=cl>sudo apt install redis-server -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 或者从源码编译最新版本</span>
</span></span><span class=line><span class=cl>wget https://download.redis.io/redis-stable.tar.gz
</span></span><span class=line><span class=cl>tar -xzf redis-stable.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> redis-stable
</span></span><span class=line><span class=cl>make
</span></span><span class=line><span class=cl>sudo make install
</span></span></code></pre></td></tr></table></div></div><h4 id=centosrhel-系统>CentOS/RHEL 系统</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装 EPEL 仓库</span>
</span></span><span class=line><span class=cl>sudo yum install epel-release -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装 Redis</span>
</span></span><span class=line><span class=cl>sudo yum install redis -y
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 或使用 dnf (CentOS 8+)</span>
</span></span><span class=line><span class=cl>sudo dnf install redis -y
</span></span></code></pre></td></tr></table></div></div><h4 id=macos-系统>macOS 系统</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 使用 Homebrew 安装</span>
</span></span><span class=line><span class=cl>brew install redis
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 或者使用 MacPorts</span>
</span></span><span class=line><span class=cl>sudo port install redis
</span></span></code></pre></td></tr></table></div></div><h3 id=13-redis-安装验证和故障排除>1.3 Redis 安装验证和故障排除</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建 Redis 安装检查脚本</span>
</span></span><span class=line><span class=cl>cat &gt; ~/redis-practice/check-redis-installation.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== Redis 安装状态检查 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 检查 redis-server
</span></span></span><span class=line><span class=cl><span class=s>if command -v redis-server &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;✅ redis-server 已安装: $(which redis-server)&#34;
</span></span></span><span class=line><span class=cl><span class=s>    redis-server --version
</span></span></span><span class=line><span class=cl><span class=s>else
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;❌ redis-server 未找到&#34;
</span></span></span><span class=line><span class=cl><span class=s>    REDIS_MISSING=1
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 检查 redis-cli
</span></span></span><span class=line><span class=cl><span class=s>if command -v redis-cli &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;✅ redis-cli 已安装: $(which redis-cli)&#34;
</span></span></span><span class=line><span class=cl><span class=s>else
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;❌ redis-cli 未找到&#34;
</span></span></span><span class=line><span class=cl><span class=s>    REDIS_MISSING=1
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 检查 redis-sentinel
</span></span></span><span class=line><span class=cl><span class=s>if command -v redis-sentinel &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;✅ redis-sentinel 已安装: $(which redis-sentinel)&#34;
</span></span></span><span class=line><span class=cl><span class=s>else
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;⚠️  redis-sentinel 未找到，将使用 redis-server --sentinel 模式&#34;
</span></span></span><span class=line><span class=cl><span class=s>    if command -v redis-server &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;✅ 可以使用 redis-server --sentinel 启动哨兵&#34;
</span></span></span><span class=line><span class=cl><span class=s>    else
</span></span></span><span class=line><span class=cl><span class=s>        REDIS_MISSING=1
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>if [ &#34;$REDIS_MISSING&#34; = &#34;1&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;❌ Redis 未正确安装，请选择以下安装方式：&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;Ubuntu/Debian:&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;  sudo apt update &amp;&amp; sudo apt install redis-server -y&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;CentOS/RHEL:&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;  sudo yum install epel-release -y &amp;&amp; sudo yum install redis -y&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;macOS:&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;  brew install redis&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;从源码编译:&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;  wget https://download.redis.io/redis-stable.tar.gz&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;  tar -xzf redis-stable.tar.gz&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;  cd redis-stable &amp;&amp; make &amp;&amp; sudo make install&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    exit 1
</span></span></span><span class=line><span class=cl><span class=s>else
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;✅ Redis 安装检查完成，可以开始架构搭建实践&#34;
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/check-redis-installation.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行安装检查</span>
</span></span><span class=line><span class=cl>~/redis-practice/check-redis-installation.sh
</span></span></code></pre></td></tr></table></div></div><h3 id=14-创建工作目录>1.4 创建工作目录</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p ~/redis-practice
</span></span><span class=line><span class=cl><span class=nb>cd</span> ~/redis-practice
</span></span><span class=line><span class=cl>mkdir -p <span class=o>{</span>master-slave,cluster,sentinel<span class=o>}</span>/<span class=o>{</span>conf,data,logs<span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=15-redis-版本兼容性检查>1.5 Redis 版本兼容性检查</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建版本兼容性检查脚本</span>
</span></span><span class=line><span class=cl>cat &gt; ~/redis-practice/check-redis-version.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== Redis 版本检查 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>REDIS_VERSION=$(redis-server --version | grep -oE &#34;[0-9]+\.[0-9]+&#34; | head -1)
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;检测到 Redis 版本: $REDIS_VERSION&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>MAJOR_VERSION=$(echo $REDIS_VERSION | cut -d. -f1)
</span></span></span><span class=line><span class=cl><span class=s>MINOR_VERSION=$(echo $REDIS_VERSION | cut -d. -f2)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;主版本号: $MAJOR_VERSION, 次版本号: $MINOR_VERSION&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>if [ $MAJOR_VERSION -ge 5 ]; then
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;✅ Redis 5.0+ 版本，支持 replica-* 指令&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;建议使用: replicaof, replica-serve-stale-data, replica-read-only&#34;
</span></span></span><span class=line><span class=cl><span class=s>else
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;⚠️  Redis 4.x 版本，需要使用 slave-* 指令&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;必须使用: slaveof, slave-serve-stale-data, slave-read-only&#34;
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;当前指南已针对 Redis 4.x 兼容性进行配置&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;如果您使用 Redis 5.0+，配置文件仍然有效（向后兼容）&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/check-redis-version.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行版本检查</span>
</span></span><span class=line><span class=cl>~/redis-practice/check-redis-version.sh
</span></span></code></pre></td></tr></table></div></div><h2 id=2-主从复制架构-master-slave>2 主从复制架构 (Master-Slave)</h2><h3 id=21-架构说明>2.1 架构说明</h3><ul><li>1个主节点 (Master)：负责写操作</li><li>2个从节点 (Slave)：负责读操作，从主节点同步数据</li></ul><h3 id=22-配置文件准备>2.2 配置文件准备</h3><h4 id=主节点配置-redis-masterconf>主节点配置 (redis-master.conf)</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; ~/redis-practice/master-slave/conf/redis-master.conf <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s># 基本配置
</span></span></span><span class=line><span class=cl><span class=s>port 6379
</span></span></span><span class=line><span class=cl><span class=s>bind 0.0.0.0
</span></span></span><span class=line><span class=cl><span class=s>protected-mode no
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 数据持久化
</span></span></span><span class=line><span class=cl><span class=s>dir /home/$(whoami)/redis-practice/master-slave/data/master
</span></span></span><span class=line><span class=cl><span class=s>dbfilename dump-master.rdb
</span></span></span><span class=line><span class=cl><span class=s>appendonly yes
</span></span></span><span class=line><span class=cl><span class=s>appendfilename &#34;appendonly-master.aof&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 日志配置
</span></span></span><span class=line><span class=cl><span class=s>logfile /home/$(whoami)/redis-practice/master-slave/logs/redis-master.log
</span></span></span><span class=line><span class=cl><span class=s>loglevel notice
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 主从复制配置
</span></span></span><span class=line><span class=cl><span class=s># 允许从节点连接 (Redis 5.0+ 使用 replica-*, 4.0 使用 slave-*)
</span></span></span><span class=line><span class=cl><span class=s>replica-serve-stale-data yes
</span></span></span><span class=line><span class=cl><span class=s>replica-read-only yes
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 安全配置
</span></span></span><span class=line><span class=cl><span class=s>requirepass redis123
</span></span></span><span class=line><span class=cl><span class=s>masterauth redis123
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 性能优化
</span></span></span><span class=line><span class=cl><span class=s>maxmemory 256mb
</span></span></span><span class=line><span class=cl><span class=s>maxmemory-policy allkeys-lru
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=从节点1配置-redis-slave1conf>从节点1配置 (redis-slave1.conf)</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; ~/redis-practice/master-slave/conf/redis-slave1.conf <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s># 基本配置
</span></span></span><span class=line><span class=cl><span class=s>port 6380
</span></span></span><span class=line><span class=cl><span class=s>bind 0.0.0.0
</span></span></span><span class=line><span class=cl><span class=s>protected-mode no
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 数据持久化
</span></span></span><span class=line><span class=cl><span class=s>dir /home/$(whoami)/redis-practice/master-slave/data/slave1
</span></span></span><span class=line><span class=cl><span class=s>dbfilename dump-slave1.rdb
</span></span></span><span class=line><span class=cl><span class=s>appendonly yes
</span></span></span><span class=line><span class=cl><span class=s>appendfilename &#34;appendonly-slave1.aof&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 日志配置
</span></span></span><span class=line><span class=cl><span class=s>logfile /home/$(whoami)/redis-practice/master-slave/logs/redis-slave1.log
</span></span></span><span class=line><span class=cl><span class=s>loglevel notice
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 主从复制配置
</span></span></span><span class=line><span class=cl><span class=s>replicaof 127.0.0.1 6379
</span></span></span><span class=line><span class=cl><span class=s>replica-serve-stale-data yes
</span></span></span><span class=line><span class=cl><span class=s>replica-read-only yes
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 安全配置
</span></span></span><span class=line><span class=cl><span class=s>requirepass redis123
</span></span></span><span class=line><span class=cl><span class=s>masterauth redis123
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 性能优化
</span></span></span><span class=line><span class=cl><span class=s>maxmemory 256mb
</span></span></span><span class=line><span class=cl><span class=s>maxmemory-policy allkeys-lru
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=从节点2配置-redis-slave2conf>从节点2配置 (redis-slave2.conf)</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; ~/redis-practice/master-slave/conf/redis-slave2.conf <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s># 基本配置
</span></span></span><span class=line><span class=cl><span class=s>port 6381
</span></span></span><span class=line><span class=cl><span class=s>bind 0.0.0.0
</span></span></span><span class=line><span class=cl><span class=s>protected-mode no
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 数据持久化
</span></span></span><span class=line><span class=cl><span class=s>dir /home/$(whoami)/redis-practice/master-slave/data/slave2
</span></span></span><span class=line><span class=cl><span class=s>dbfilename dump-slave2.rdb
</span></span></span><span class=line><span class=cl><span class=s>appendonly yes
</span></span></span><span class=line><span class=cl><span class=s>appendfilename &#34;appendonly-slave2.aof&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 日志配置
</span></span></span><span class=line><span class=cl><span class=s>logfile /home/$(whoami)/redis-practice/master-slave/logs/redis-slave2.log
</span></span></span><span class=line><span class=cl><span class=s>loglevel notice
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 主从复制配置
</span></span></span><span class=line><span class=cl><span class=s>replicaof 127.0.0.1 6379
</span></span></span><span class=line><span class=cl><span class=s>replica-serve-stale-data yes
</span></span></span><span class=line><span class=cl><span class=s>replica-read-only yes
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 安全配置
</span></span></span><span class=line><span class=cl><span class=s>requirepass redis123
</span></span></span><span class=line><span class=cl><span class=s>masterauth redis123
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 性能优化
</span></span></span><span class=line><span class=cl><span class=s>maxmemory 256mb
</span></span></span><span class=line><span class=cl><span class=s>maxmemory-policy allkeys-lru
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=23-关键命令详解>2.3 关键命令详解</h3><p>在使用脚本之前，让我们先了解主从复制的核心命令：</p><h4 id=redis-主从复制核心命令>Redis 主从复制核心命令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 启动 Redis 服务器的基本命令</span>
</span></span><span class=line><span class=cl>redis-server <span class=o>[</span>配置文件路径<span class=o>]</span>           <span class=c1># 启动Redis服务器</span>
</span></span><span class=line><span class=cl>redis-server --port <span class=m>6379</span>             <span class=c1># 指定端口启动</span>
</span></span><span class=line><span class=cl>redis-server --daemonize yes         <span class=c1># 后台运行模式</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 主从复制配置命令</span>
</span></span><span class=line><span class=cl><span class=c1># 在从节点上执行，建立主从关系</span>
</span></span><span class=line><span class=cl>REPLICAOF 127.0.0.1 <span class=m>6379</span>            <span class=c1># Redis 5.0+ 建立主从关系</span>
</span></span><span class=line><span class=cl>SLAVEOF 127.0.0.1 <span class=m>6379</span>              <span class=c1># Redis 4.x 建立主从关系</span>
</span></span><span class=line><span class=cl>SLAVEOF NO ONE                       <span class=c1># 取消主从关系，提升为主节点</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 认证命令</span>
</span></span><span class=line><span class=cl>AUTH redis123                        <span class=c1># 客户端认证</span>
</span></span><span class=line><span class=cl>CONFIG SET masterauth redis123       <span class=c1># 设置主节点认证密码</span>
</span></span><span class=line><span class=cl>CONFIG SET requirepass redis123      <span class=c1># 设置访问密码</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 复制状态查看命令</span>
</span></span><span class=line><span class=cl>INFO replication                     <span class=c1># 查看复制状态信息</span>
</span></span><span class=line><span class=cl>INFO server                          <span class=c1># 查看服务器信息</span>
</span></span><span class=line><span class=cl>PING                                 <span class=c1># 测试连接</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 数据同步相关</span>
</span></span><span class=line><span class=cl>PSYNC &lt;replication_id&gt; &lt;offset&gt;      <span class=c1># 部分重同步命令（内部使用）</span>
</span></span><span class=line><span class=cl>FULLRESYNC                          <span class=c1># 全量重同步（内部使用）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 配置文件中的关键参数</span>
</span></span><span class=line><span class=cl><span class=c1># replicaof &lt;masterip&gt; &lt;masterport&gt;   # 指定主节点</span>
</span></span><span class=line><span class=cl><span class=c1># replica-read-only yes               # 从节点只读</span>
</span></span><span class=line><span class=cl><span class=c1># replica-serve-stale-data yes        # 从节点在连接断开时是否提供旧数据</span>
</span></span><span class=line><span class=cl><span class=c1># repl-diskless-sync no               # 是否使用无盘复制</span>
</span></span><span class=line><span class=cl><span class=c1># repl-diskless-sync-delay 5          # 无盘复制延迟时间</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=手动建立主从复制示例>手动建立主从复制示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 启动主节点（端口6379）</span>
</span></span><span class=line><span class=cl>redis-server --port <span class=m>6379</span> --requirepass redis123 --masterauth redis123 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>             --dir /tmp/master --dbfilename master.rdb <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>             --logfile /tmp/master.log --daemonize yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 启动从节点1（端口6380）</span>
</span></span><span class=line><span class=cl>redis-server --port <span class=m>6380</span> --requirepass redis123 --masterauth redis123 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>             --dir /tmp/slave1 --dbfilename slave1.rdb <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>             --logfile /tmp/slave1.log --daemonize yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 在从节点建立主从关系</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6380</span> -a redis123 REPLICAOF 127.0.0.1 <span class=m>6379</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 验证主从状态</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a redis123 INFO replication  <span class=c1># 查看主节点状态</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6380</span> -a redis123 INFO replication  <span class=c1># 查看从节点状态</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 测试数据同步</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a redis123 SET test_key <span class=s2>&#34;hello world&#34;</span>  <span class=c1># 主节点写入</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6380</span> -a redis123 GET test_key                <span class=c1># 从节点读取</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 停止服务</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a redis123 SHUTDOWN  <span class=c1># 关闭主节点</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6380</span> -a redis123 SHUTDOWN  <span class=c1># 关闭从节点</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=启动主从架构>启动主从架构</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建启动脚本</span>
</span></span><span class=line><span class=cl>cat &gt; ~/redis-practice/master-slave/start-master-slave.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>BASE_DIR=~/redis-practice/master-slave
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 启动 Redis 主从架构 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 创建数据目录
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;创建数据目录...&#34;
</span></span></span><span class=line><span class=cl><span class=s>mkdir -p $BASE_DIR/data/{master,slave1,slave2}
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 检查配置文件是否存在
</span></span></span><span class=line><span class=cl><span class=s>for conf in redis-master.conf redis-slave1.conf redis-slave2.conf; do
</span></span></span><span class=line><span class=cl><span class=s>    if [ ! -f &#34;$BASE_DIR/conf/$conf&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;错误: 配置文件 $conf 不存在！&#34;
</span></span></span><span class=line><span class=cl><span class=s>        exit 1
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 启动主节点
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;启动主节点 (端口 6379)...&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-server $BASE_DIR/conf/redis-master.conf &amp;
</span></span></span><span class=line><span class=cl><span class=s>MASTER_PID=$!
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 等待主节点启动
</span></span></span><span class=line><span class=cl><span class=s>sleep 3
</span></span></span><span class=line><span class=cl><span class=s>if ! redis-cli -p 6379 -a redis123 ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;错误: 主节点启动失败！&#34;
</span></span></span><span class=line><span class=cl><span class=s>    exit 1
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;✅ 主节点启动成功 (PID: $MASTER_PID)&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 启动从节点1
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;启动从节点1 (端口 6380)...&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-server $BASE_DIR/conf/redis-slave1.conf &amp;
</span></span></span><span class=line><span class=cl><span class=s>SLAVE1_PID=$!
</span></span></span><span class=line><span class=cl><span class=s>sleep 2
</span></span></span><span class=line><span class=cl><span class=s>if ! redis-cli -p 6380 -a redis123 ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;错误: 从节点1启动失败！&#34;
</span></span></span><span class=line><span class=cl><span class=s>    exit 1
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;✅ 从节点1启动成功 (PID: $SLAVE1_PID)&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 启动从节点2
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;启动从节点2 (端口 6381)...&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-server $BASE_DIR/conf/redis-slave2.conf &amp;
</span></span></span><span class=line><span class=cl><span class=s>SLAVE2_PID=$!
</span></span></span><span class=line><span class=cl><span class=s>sleep 2
</span></span></span><span class=line><span class=cl><span class=s>if ! redis-cli -p 6381 -a redis123 ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;错误: 从节点2启动失败！&#34;
</span></span></span><span class=line><span class=cl><span class=s>    exit 1
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;✅ 从节点2启动成功 (PID: $SLAVE2_PID)&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 等待主从同步
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;等待主从同步...&#34;
</span></span></span><span class=line><span class=cl><span class=s>sleep 5
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 验证主从关系
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 验证主从复制状态 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;主节点信息:&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 6379 -a redis123 info replication | grep -E &#34;role|connected_slaves&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;\n从节点1信息:&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 6380 -a redis123 info replication | grep -E &#34;role|master_host|master_port&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;\n从节点2信息:&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 6381 -a redis123 info replication | grep -E &#34;role|master_host|master_port&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;\n=== 主从架构启动完成！===&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;主节点: 127.0.0.1:6379&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;从节点1: 127.0.0.1:6380&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;从节点2: 127.0.0.1:6381&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;密码: redis123&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 保存进程ID
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;$MASTER_PID $SLAVE1_PID $SLAVE2_PID&#34; &gt; $BASE_DIR/redis-pids.txt
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/master-slave/start-master-slave.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行启动脚本</span>
</span></span><span class=line><span class=cl>~/redis-practice/master-slave/start-master-slave.sh
</span></span></code></pre></td></tr></table></div></div><h4 id=停止主从架构>停止主从架构</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建停止脚本</span>
</span></span><span class=line><span class=cl>cat &gt; ~/redis-practice/master-slave/stop-master-slave.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>BASE_DIR=~/redis-practice/master-slave
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 停止 Redis 主从架构 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 优雅关闭 Redis 实例
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;正在停止 Redis 实例...&#34;
</span></span></span><span class=line><span class=cl><span class=s>for port in 6379 6380 6381; do
</span></span></span><span class=line><span class=cl><span class=s>    if redis-cli -p $port -a redis123 ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;停止端口 $port 上的 Redis 实例&#34;
</span></span></span><span class=line><span class=cl><span class=s>        redis-cli -p $port -a redis123 shutdown
</span></span></span><span class=line><span class=cl><span class=s>    else
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;端口 $port 上没有运行的 Redis 实例&#34;
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 等待进程结束
</span></span></span><span class=line><span class=cl><span class=s>sleep 2
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 检查是否还有残留进程
</span></span></span><span class=line><span class=cl><span class=s>REMAINING=$(ps aux | grep -E &#34;redis-server.*master-slave&#34; | grep -v grep | wc -l)
</span></span></span><span class=line><span class=cl><span class=s>if [ $REMAINING -gt 0 ]; then
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;强制终止残留进程...&#34;
</span></span></span><span class=line><span class=cl><span class=s>    pkill -f &#34;redis-server.*master-slave&#34;
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 清理 PID 文件
</span></span></span><span class=line><span class=cl><span class=s>if [ -f &#34;$BASE_DIR/redis-pids.txt&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>    rm $BASE_DIR/redis-pids.txt
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;✅ 主从架构已停止&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/master-slave/stop-master-slave.sh
</span></span></code></pre></td></tr></table></div></div><h4 id=主从架构管理命令>主从架构管理命令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 启动主从架构</span>
</span></span><span class=line><span class=cl>~/redis-practice/master-slave/start-master-slave.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 停止主从架构</span>
</span></span><span class=line><span class=cl>~/redis-practice/master-slave/stop-master-slave.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 重启主从架构</span>
</span></span><span class=line><span class=cl>~/redis-practice/master-slave/stop-master-slave.sh <span class=o>&amp;&amp;</span> sleep <span class=m>2</span> <span class=o>&amp;&amp;</span> ~/redis-practice/master-slave/start-master-slave.sh
</span></span></code></pre></td></tr></table></div></div><h3 id=24-验证主从复制>2.4 验证主从复制</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 连接主节点并写入数据</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a redis123 <span class=nb>set</span> test-key <span class=s2>&#34;hello from master&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在从节点验证数据同步</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6380</span> -a redis123 get test-key
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6381</span> -a redis123 get test-key
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看复制状态</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a redis123 info replication
</span></span></code></pre></td></tr></table></div></div><h3 id=25-测试读写分离>2.5 测试读写分离</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 主节点写入测试</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a redis123 <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>set user:1 &#34;张三&#34;
</span></span></span><span class=line><span class=cl><span class=s>set user:2 &#34;李四&#34;
</span></span></span><span class=line><span class=cl><span class=s>hmset product:1 name &#34;iPhone&#34; price 8999
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从节点读取测试</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;从 slave1 读取数据：&#34;</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6380</span> -a redis123 get user:1
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6380</span> -a redis123 hgetall product:1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;从 slave2 读取数据：&#34;</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6381</span> -a redis123 get user:2
</span></span></code></pre></td></tr></table></div></div><h2 id=3-redis-cluster-集群架构>3 Redis Cluster 集群架构</h2><ul><li>6个节点：3个主节点 + 3个从节点</li><li>每个主节点负责一部分槽位 (0-16383)</li><li>自动故障转移和数据分片</li></ul><h3 id=31-redis-cluster-核心命令详解>3.1 Redis Cluster 核心命令详解</h3><p>在使用脚本创建集群之前，让我们先了解集群的核心命令：</p><h4 id=cluster-管理命令>Cluster 管理命令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 集群创建命令</span>
</span></span><span class=line><span class=cl><span class=c1># Redis 5.0+ 使用 redis-cli</span>
</span></span><span class=line><span class=cl>redis-cli --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                           127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                           --cluster-replicas <span class=m>1</span> -a redis123
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Redis 4.x 使用 redis-trib.rb</span>
</span></span><span class=line><span class=cl>redis-trib.rb create --replicas <span class=m>1</span> 127.0.0.1:7000 127.0.0.1:7001 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                                  127.0.0.1:7002 127.0.0.1:7003 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                                  127.0.0.1:7004 127.0.0.1:7005
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 集群状态查看命令</span>
</span></span><span class=line><span class=cl>CLUSTER NODES                        <span class=c1># 查看所有节点信息</span>
</span></span><span class=line><span class=cl>CLUSTER INFO                         <span class=c1># 查看集群整体状态</span>
</span></span><span class=line><span class=cl>CLUSTER SLOTS                        <span class=c1># 查看槽位分配情况</span>
</span></span><span class=line><span class=cl>INFO cluster                         <span class=c1># 查看集群相关信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 集群节点管理</span>
</span></span><span class=line><span class=cl>CLUSTER MEET &lt;ip&gt; &lt;port&gt;             <span class=c1># 添加节点到集群</span>
</span></span><span class=line><span class=cl>CLUSTER FORGET &lt;node-id&gt;             <span class=c1># 从集群中移除节点</span>
</span></span><span class=line><span class=cl>CLUSTER REPLICATE &lt;node-id&gt;          <span class=c1># 设置当前节点为指定节点的从节点</span>
</span></span><span class=line><span class=cl>CLUSTER RESET <span class=o>[</span>HARD<span class=p>|</span>SOFT<span class=o>]</span>            <span class=c1># 重置节点集群状态</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 槽位管理命令</span>
</span></span><span class=line><span class=cl>CLUSTER ADDSLOTS &lt;slot&gt; <span class=o>[</span>slot ...<span class=o>]</span>   <span class=c1># 为节点分配槽位</span>
</span></span><span class=line><span class=cl>CLUSTER DELSLOTS &lt;slot&gt; <span class=o>[</span>slot ...<span class=o>]</span>   <span class=c1># 删除节点的槽位</span>
</span></span><span class=line><span class=cl>CLUSTER SETSLOT &lt;slot&gt; NODE &lt;node-id&gt; <span class=c1># 将槽位分配给指定节点</span>
</span></span><span class=line><span class=cl>CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;destination-node-id&gt;  <span class=c1># 开始迁移槽位</span>
</span></span><span class=line><span class=cl>CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;source-node-id&gt;      <span class=c1># 准备接收槽位</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 数据迁移命令</span>
</span></span><span class=line><span class=cl>CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; <span class=c1># 获取槽位中的键</span>
</span></span><span class=line><span class=cl>MIGRATE &lt;host&gt; &lt;port&gt; &lt;key&gt; &lt;destination-db&gt; &lt;timeout&gt; <span class=c1># 迁移单个键</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 集群配置文件关键参数</span>
</span></span><span class=line><span class=cl><span class=c1># cluster-enabled yes                    # 启用集群模式</span>
</span></span><span class=line><span class=cl><span class=c1># cluster-config-file nodes.conf         # 集群配置文件</span>
</span></span><span class=line><span class=cl><span class=c1># cluster-node-timeout 15000             # 节点超时时间</span>
</span></span><span class=line><span class=cl><span class=c1># cluster-announce-ip 127.0.0.1          # 对外公布的IP</span>
</span></span><span class=line><span class=cl><span class=c1># cluster-announce-port 7000             # 对外公布的端口</span>
</span></span><span class=line><span class=cl><span class=c1># cluster-require-full-coverage no       # 是否要求全部槽位可用</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=手动创建集群示例>手动创建集群示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 启动所有节点（不组成集群）</span>
</span></span><span class=line><span class=cl><span class=k>for</span> port in <span class=m>7000</span> <span class=m>7001</span> <span class=m>7002</span> <span class=m>7003</span> <span class=m>7004</span> 7005<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    redis-server --port <span class=nv>$port</span> --cluster-enabled yes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                 --cluster-config-file nodes-<span class=nv>$port</span>.conf <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                 --cluster-node-timeout <span class=m>5000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                 --requirepass redis123 --masterauth redis123 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                 --daemonize yes --dir /tmp/cluster-<span class=nv>$port</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 手动组建集群（逐步建立）</span>
</span></span><span class=line><span class=cl><span class=c1># 第一步：让节点相互认识</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>7000</span> -a redis123 CLUSTER MEET 127.0.0.1 <span class=m>7001</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>7000</span> -a redis123 CLUSTER MEET 127.0.0.1 <span class=m>7002</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>7000</span> -a redis123 CLUSTER MEET 127.0.0.1 <span class=m>7003</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>7000</span> -a redis123 CLUSTER MEET 127.0.0.1 <span class=m>7004</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>7000</span> -a redis123 CLUSTER MEET 127.0.0.1 <span class=m>7005</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第二步：分配槽位（共 16384 个槽位，编号 0-16383）</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>7000</span> -a redis123 CLUSTER ADDSLOTS <span class=o>{</span>0..5461<span class=o>}</span>     <span class=c1># 节点 7000</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>7001</span> -a redis123 CLUSTER ADDSLOTS <span class=o>{</span>5462..10922<span class=o>}</span> <span class=c1># 节点 7001</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>7002</span> -a redis123 CLUSTER ADDSLOTS <span class=o>{</span>10923..16383<span class=o>}</span> <span class=c1># 节点 7002</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第三步：设置主从关系（需要先获取节点 ID）</span>
</span></span><span class=line><span class=cl><span class=nv>NODE_7000</span><span class=o>=</span><span class=k>$(</span>redis-cli -p <span class=m>7000</span> -a redis123 CLUSTER NODES <span class=p>|</span> grep myself <span class=p>|</span> awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>NODE_7001</span><span class=o>=</span><span class=k>$(</span>redis-cli -p <span class=m>7001</span> -a redis123 CLUSTER NODES <span class=p>|</span> grep myself <span class=p>|</span> awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>NODE_7002</span><span class=o>=</span><span class=k>$(</span>redis-cli -p <span class=m>7002</span> -a redis123 CLUSTER NODES <span class=p>|</span> grep myself <span class=p>|</span> awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置 7003 为 7000 的从节点</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>7003</span> -a redis123 CLUSTER REPLICATE <span class=nv>$NODE_7000</span>
</span></span><span class=line><span class=cl><span class=c1># 设置 7004 为 7001 的从节点</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>7004</span> -a redis123 CLUSTER REPLICATE <span class=nv>$NODE_7001</span>
</span></span><span class=line><span class=cl><span class=c1># 设置 7005 为 7002 的从节点</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>7005</span> -a redis123 CLUSTER REPLICATE <span class=nv>$NODE_7002</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 验证集群状态</span>
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a redis123 CLUSTER NODES
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a redis123 CLUSTER INFO
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 测试数据分片（使用 -c 参数启用集群模式）</span>
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a redis123 SET user:1001 <span class=s2>&#34;Alice&#34;</span>
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a redis123 SET user:1002 <span class=s2>&#34;Bob&#34;</span>
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a redis123 GET user:1001
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a redis123 GET user:1002
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 查看键的槽位分布</span>
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a redis123 CLUSTER KEYSLOT user:1001
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a redis123 CLUSTER KEYSLOT user:1002
</span></span></code></pre></td></tr></table></div></div><h3 id=32-集群节点配置>3.2 集群节点配置</h3><h4 id=创建集群配置模板>创建集群配置模板</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建集群配置生成脚本</span>
</span></span><span class=line><span class=cl>cat &gt; ~/redis-practice/cluster/create-cluster-configs.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>BASE_DIR=~/redis-practice/cluster
</span></span></span><span class=line><span class=cl><span class=s>PORTS=(7000 7001 7002 7003 7004 7005)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>for port in &#34;${PORTS[@]}&#34;; do
</span></span></span><span class=line><span class=cl><span class=s>    mkdir -p $BASE_DIR/data/node-$port
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    cat &gt; $BASE_DIR/conf/redis-$port.conf &lt;&lt; CONFIG
</span></span></span><span class=line><span class=cl><span class=s># 基本配置
</span></span></span><span class=line><span class=cl><span class=s>port $port
</span></span></span><span class=line><span class=cl><span class=s>bind 0.0.0.0
</span></span></span><span class=line><span class=cl><span class=s>protected-mode no
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 集群配置
</span></span></span><span class=line><span class=cl><span class=s>cluster-enabled yes
</span></span></span><span class=line><span class=cl><span class=s>cluster-config-file $BASE_DIR/data/node-$port/nodes-$port.conf
</span></span></span><span class=line><span class=cl><span class=s>cluster-node-timeout 15000
</span></span></span><span class=line><span class=cl><span class=s>cluster-announce-ip 127.0.0.1
</span></span></span><span class=line><span class=cl><span class=s>cluster-announce-port $port
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 数据持久化
</span></span></span><span class=line><span class=cl><span class=s>dir $BASE_DIR/data/node-$port
</span></span></span><span class=line><span class=cl><span class=s>dbfilename dump-$port.rdb
</span></span></span><span class=line><span class=cl><span class=s>appendonly yes
</span></span></span><span class=line><span class=cl><span class=s>appendfilename &#34;appendonly-$port.aof&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 日志配置
</span></span></span><span class=line><span class=cl><span class=s>logfile $BASE_DIR/logs/redis-$port.log
</span></span></span><span class=line><span class=cl><span class=s>loglevel notice
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 安全配置
</span></span></span><span class=line><span class=cl><span class=s>requirepass redis123
</span></span></span><span class=line><span class=cl><span class=s>masterauth redis123
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 性能配置
</span></span></span><span class=line><span class=cl><span class=s>maxmemory 256mb
</span></span></span><span class=line><span class=cl><span class=s>maxmemory-policy allkeys-lru
</span></span></span><span class=line><span class=cl><span class=s>CONFIG
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;集群配置文件生成完成！&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/cluster/create-cluster-configs.sh
</span></span><span class=line><span class=cl>~/redis-practice/cluster/create-cluster-configs.sh
</span></span></code></pre></td></tr></table></div></div><h3 id=33-启动集群节点>3.3 启动集群节点</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 启动所有集群节点</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> ~/redis-practice/cluster
</span></span><span class=line><span class=cl><span class=k>for</span> port in <span class=m>7000</span> <span class=m>7001</span> <span class=m>7002</span> <span class=m>7003</span> <span class=m>7004</span> 7005<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;启动节点 </span><span class=nv>$port</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    redis-server conf/redis-<span class=nv>$port</span>.conf <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>    sleep <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 等待所有节点启动</span>
</span></span><span class=line><span class=cl>sleep <span class=m>5</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;所有节点启动完成&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=34-创建集群>3.4 创建集群</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建集群 (Redis 5.0+ 使用 redis-cli)</span>
</span></span><span class=line><span class=cl>redis-cli --cluster create <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --cluster-replicas <span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -a redis123
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 如果是 Redis 4.x，使用 redis-trib.rb</span>
</span></span><span class=line><span class=cl><span class=c1># redis-trib.rb create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 ...</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=35-验证集群状态>3.5 验证集群状态</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看集群信息</span>
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a redis123 cluster info
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a redis123 cluster nodes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试集群数据分片</span>
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a redis123 <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>set name &#34;Redis集群测试&#34;
</span></span></span><span class=line><span class=cl><span class=s>set age 25
</span></span></span><span class=line><span class=cl><span class=s>set city &#34;北京&#34;
</span></span></span><span class=line><span class=cl><span class=s>get name
</span></span></span><span class=line><span class=cl><span class=s>get age
</span></span></span><span class=line><span class=cl><span class=s>get city
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=36-集群管理操作>3.6 集群管理操作</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建集群管理脚本</span>
</span></span><span class=line><span class=cl>cat &gt; ~/redis-practice/cluster/cluster-manager.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>REDIS_PASSWORD=&#34;redis123&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>case $1 in
</span></span></span><span class=line><span class=cl><span class=s>    &#34;status&#34;)
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;=== 集群状态 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>        redis-cli -c -p 7000 -a $REDIS_PASSWORD cluster info
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;=== 节点信息 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>        redis-cli -c -p 7000 -a $REDIS_PASSWORD cluster nodes
</span></span></span><span class=line><span class=cl><span class=s>        ;;
</span></span></span><span class=line><span class=cl><span class=s>    &#34;test&#34;)
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;=== 测试数据写入 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>        for i in {1..10}; do
</span></span></span><span class=line><span class=cl><span class=s>            redis-cli -c -p 7000 -a $REDIS_PASSWORD set &#34;test:$i&#34; &#34;value-$i&#34;
</span></span></span><span class=line><span class=cl><span class=s>        done
</span></span></span><span class=line><span class=cl><span class=s>        
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;=== 测试数据读取 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>        for i in {1..10}; do
</span></span></span><span class=line><span class=cl><span class=s>            redis-cli -c -p 7000 -a $REDIS_PASSWORD get &#34;test:$i&#34;
</span></span></span><span class=line><span class=cl><span class=s>        done
</span></span></span><span class=line><span class=cl><span class=s>        ;;
</span></span></span><span class=line><span class=cl><span class=s>    &#34;shutdown&#34;)
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;=== 关闭集群 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>        for port in 7000 7001 7002 7003 7004 7005; do
</span></span></span><span class=line><span class=cl><span class=s>            redis-cli -p $port -a $REDIS_PASSWORD shutdown
</span></span></span><span class=line><span class=cl><span class=s>        done
</span></span></span><span class=line><span class=cl><span class=s>        ;;
</span></span></span><span class=line><span class=cl><span class=s>    *)
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;用法: $0 {status|test|shutdown}&#34;
</span></span></span><span class=line><span class=cl><span class=s>        ;;
</span></span></span><span class=line><span class=cl><span class=s>esac
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/cluster/cluster-manager.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试集群</span>
</span></span><span class=line><span class=cl>~/redis-practice/cluster/cluster-manager.sh status
</span></span><span class=line><span class=cl>~/redis-practice/cluster/cluster-manager.sh <span class=nb>test</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=4-redis-sentinel-哨兵架构>4 Redis Sentinel 哨兵架构</h2><h3 id=41-redis-sentinel-核心命令详解>4.1 Redis Sentinel 核心命令详解</h3><p>在使用 Sentinel 脚本之前，让我们先了解 Sentinel 的核心命令：</p><h4 id=sentinel-管理命令>Sentinel 管理命令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 启动 Sentinel 服务</span>
</span></span><span class=line><span class=cl>redis-sentinel sentinel.conf         <span class=c1># 使用配置文件启动</span>
</span></span><span class=line><span class=cl>redis-server sentinel.conf --sentinel <span class=c1># 更新的启动方式</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. Sentinel 监控命令</span>
</span></span><span class=line><span class=cl>SENTINEL MASTERS                     <span class=c1># 查看所有被监控的主节点</span>
</span></span><span class=line><span class=cl>SENTINEL MASTER mymaster             <span class=c1># 查看指定主节点的详细信息</span>
</span></span><span class=line><span class=cl>SENTINEL SLAVES mymaster             <span class=c1># 查看主节点下的所有从节点</span>
</span></span><span class=line><span class=cl>SENTINEL SENTINELS mymaster          <span class=c1># 查看监控同一主节点的其他 Sentinel</span>
</span></span><span class=line><span class=cl>SENTINEL GET-MASTER-ADDR-BY-NAME mymaster <span class=c1># 获取主节点地址</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 故障转移命令</span>
</span></span><span class=line><span class=cl>SENTINEL FAILOVER mymaster           <span class=c1># 手动触发故障转移</span>
</span></span><span class=line><span class=cl>SENTINEL CKQUORUM mymaster           <span class=c1># 检查故障转移条件</span>
</span></span><span class=line><span class=cl>SENTINEL FLUSHCONFIG                 <span class=c1># 刷新配置到磁盘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 动态配置修改</span>
</span></span><span class=line><span class=cl>SENTINEL MONITOR mymaster 127.0.0.1 <span class=m>6379</span> <span class=m>2</span>  <span class=c1># 动态添加监控</span>
</span></span><span class=line><span class=cl>SENTINEL REMOVE mymaster                     <span class=c1># 移除监控</span>
</span></span><span class=line><span class=cl>SENTINEL SET mymaster down-after-milliseconds <span class=m>10000</span>  <span class=c1># 修改参数</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 信息查询</span>
</span></span><span class=line><span class=cl>SENTINEL PENDING-SCRIPTS             <span class=c1># 查看待执行的脚本</span>
</span></span><span class=line><span class=cl>SENTINEL IS-MASTER-DOWN-BY-ADDR 127.0.0.1 <span class=m>6379</span> <span class=c1># 查询主节点是否下线</span>
</span></span><span class=line><span class=cl>INFO sentinel                        <span class=c1># 查看 Sentinel 状态信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. Sentinel 配置文件关键参数</span>
</span></span><span class=line><span class=cl><span class=c1># sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># sentinel parallel-syncs &lt;master-name&gt; &lt;numreplicas&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=手动配置-sentinel-示例>手动配置 Sentinel 示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 准备主从架构（先启动 Redis 主从节点）</span>
</span></span><span class=line><span class=cl>redis-server --port <span class=m>6379</span> --requirepass redis123 --masterauth redis123 --daemonize yes
</span></span><span class=line><span class=cl>redis-server --port <span class=m>6380</span> --requirepass redis123 --masterauth redis123 --daemonize yes
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6380</span> -a redis123 REPLICAOF 127.0.0.1 <span class=m>6379</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 创建 Sentinel 配置文件</span>
</span></span><span class=line><span class=cl>cat &gt; /tmp/sentinel-26379.conf <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>port 26379
</span></span></span><span class=line><span class=cl><span class=s>dir /tmp
</span></span></span><span class=line><span class=cl><span class=s>sentinel monitor mymaster 127.0.0.1 6379 2
</span></span></span><span class=line><span class=cl><span class=s>sentinel auth-pass mymaster redis123
</span></span></span><span class=line><span class=cl><span class=s>sentinel down-after-milliseconds mymaster 5000
</span></span></span><span class=line><span class=cl><span class=s>sentinel parallel-syncs mymaster 1
</span></span></span><span class=line><span class=cl><span class=s>sentinel failover-timeout mymaster 10000
</span></span></span><span class=line><span class=cl><span class=s>requirepass sentinel123
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 启动 Sentinel</span>
</span></span><span class=line><span class=cl>redis-sentinel /tmp/sentinel-26379.conf <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 连接 Sentinel 并查看状态</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>26379</span> -a sentinel123
</span></span><span class=line><span class=cl>&gt; SENTINEL MASTERS
</span></span><span class=line><span class=cl>&gt; SENTINEL SLAVES mymaster
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 模拟主节点故障（关闭主节点）</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a redis123 DEBUG SEGFAULT  <span class=c1># 模拟崩溃</span>
</span></span><span class=line><span class=cl><span class=c1># 或者</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a redis123 SHUTDOWN         <span class=c1># 正常关闭</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 观察 Sentinel 日志，查看故障转移过程</span>
</span></span><span class=line><span class=cl>tail -f /tmp/sentinel-26379.log
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7. 查看新的主节点</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>26379</span> -a sentinel123 SENTINEL GET-MASTER-ADDR-BY-NAME mymaster
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 8. 测试新主节点是否可写入</span>
</span></span><span class=line><span class=cl><span class=nv>NEW_MASTER_PORT</span><span class=o>=</span><span class=k>$(</span>redis-cli -p <span class=m>26379</span> -a sentinel123 SENTINEL GET-MASTER-ADDR-BY-NAME mymaster <span class=p>|</span> tail -1<span class=k>)</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=nv>$NEW_MASTER_PORT</span> -a redis123 SET failover-test <span class=s2>&#34;success&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=sentinel-客户端连接示例>Sentinel 客户端连接示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Python 使用 Sentinel 的示例代码</span>
</span></span><span class=line><span class=cl>cat &gt; sentinel_client_example.py <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>from redis.sentinel import Sentinel
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 连接 Sentinel
</span></span></span><span class=line><span class=cl><span class=s>sentinel = Sentinel([(&#39;127.0.0.1&#39;, 26379), (&#39;127.0.0.1&#39;, 26380)], 
</span></span></span><span class=line><span class=cl><span class=s>                   socket_timeout=0.1,
</span></span></span><span class=line><span class=cl><span class=s>                   password=&#39;sentinel123&#39;)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 发现主节点
</span></span></span><span class=line><span class=cl><span class=s>master = sentinel.master_for(&#39;mymaster&#39;, socket_timeout=0.1, password=&#39;redis123&#39;)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 发现从节点
</span></span></span><span class=line><span class=cl><span class=s>slave = sentinel.slave_for(&#39;mymaster&#39;, socket_timeout=0.1, password=&#39;redis123&#39;)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 使用
</span></span></span><span class=line><span class=cl><span class=s>master.set(&#39;foo&#39;, &#39;bar&#39;)
</span></span></span><span class=line><span class=cl><span class=s>print(slave.get(&#39;foo&#39;))
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Java 使用 Sentinel 的示例代码</span>
</span></span><span class=line><span class=cl>cat &gt; SentinelExample.java <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>import redis.clients.jedis.Jedis;
</span></span></span><span class=line><span class=cl><span class=s>import redis.clients.jedis.JedisSentinelPool;
</span></span></span><span class=line><span class=cl><span class=s>import java.util.HashSet;
</span></span></span><span class=line><span class=cl><span class=s>import java.util.Set;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>public class SentinelExample {
</span></span></span><span class=line><span class=cl><span class=s>    public static void main(String[] args) {
</span></span></span><span class=line><span class=cl><span class=s>        Set&lt;String&gt; sentinels = new HashSet&lt;&gt;();
</span></span></span><span class=line><span class=cl><span class=s>        sentinels.add(&#34;127.0.0.1:26379&#34;);
</span></span></span><span class=line><span class=cl><span class=s>        sentinels.add(&#34;127.0.0.1:26380&#34;);
</span></span></span><span class=line><span class=cl><span class=s>        
</span></span></span><span class=line><span class=cl><span class=s>        JedisSentinelPool pool = new JedisSentinelPool(&#34;mymaster&#34;, sentinels, &#34;redis123&#34;);
</span></span></span><span class=line><span class=cl><span class=s>        
</span></span></span><span class=line><span class=cl><span class=s>        try (Jedis jedis = pool.getResource()) {
</span></span></span><span class=line><span class=cl><span class=s>            jedis.set(&#34;test&#34;, &#34;value&#34;);
</span></span></span><span class=line><span class=cl><span class=s>            System.out.println(jedis.get(&#34;test&#34;));
</span></span></span><span class=line><span class=cl><span class=s>        }
</span></span></span><span class=line><span class=cl><span class=s>        
</span></span></span><span class=line><span class=cl><span class=s>        pool.close();
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=42-架构说明>4.2 架构说明</h3><ul><li>1个主节点 + 2个从节点</li><li>3个 Sentinel 哨兵节点监控主从节点</li><li>自动故障发现和主从切换</li></ul><h4 id=准备-redis-主从节点>准备 Redis 主从节点</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 复用主从架构的配置，但需要修改一些参数</span>
</span></span><span class=line><span class=cl>cp ~/redis-practice/master-slave/conf/* ~/redis-practice/sentinel/conf/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改主节点配置以适配 Sentinel</span>
</span></span><span class=line><span class=cl>cat &gt; ~/redis-practice/sentinel/conf/redis-master.conf <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>port 6379
</span></span></span><span class=line><span class=cl><span class=s>bind 0.0.0.0
</span></span></span><span class=line><span class=cl><span class=s>protected-mode no
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>dir /home/$(whoami)/redis-practice/sentinel/data/master
</span></span></span><span class=line><span class=cl><span class=s>dbfilename dump-master.rdb
</span></span></span><span class=line><span class=cl><span class=s>appendonly yes
</span></span></span><span class=line><span class=cl><span class=s>appendfilename &#34;appendonly-master.aof&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>logfile /home/$(whoami)/redis-practice/sentinel/logs/redis-master.log
</span></span></span><span class=line><span class=cl><span class=s>loglevel notice
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Sentinel 需要的配置
</span></span></span><span class=line><span class=cl><span class=s>slave-serve-stale-data yes
</span></span></span><span class=line><span class=cl><span class=s>slave-read-only yes
</span></span></span><span class=line><span class=cl><span class=s>slave-priority 100
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>requirepass redis123
</span></span></span><span class=line><span class=cl><span class=s>masterauth redis123
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>maxmemory 256mb
</span></span></span><span class=line><span class=cl><span class=s>maxmemory-policy allkeys-lru
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改从节点配置</span>
</span></span><span class=line><span class=cl>sed <span class=s1>&#39;s|master-slave|sentinel|g&#39;</span> ~/redis-practice/master-slave/conf/redis-slave1.conf &gt; ~/redis-practice/sentinel/conf/redis-slave1.conf
</span></span><span class=line><span class=cl>sed <span class=s1>&#39;s|master-slave|sentinel|g&#39;</span> ~/redis-practice/master-slave/conf/redis-slave2.conf &gt; ~/redis-practice/sentinel/conf/redis-slave2.conf
</span></span></code></pre></td></tr></table></div></div><h4 id=配置-sentinel-哨兵>配置 Sentinel 哨兵</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建 Sentinel 配置</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=m>1</span> <span class=m>2</span> 3<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nv>port</span><span class=o>=</span><span class=k>$((</span><span class=m>26378</span> <span class=o>+</span> i<span class=k>))</span>
</span></span><span class=line><span class=cl>    cat &gt; ~/redis-practice/sentinel/conf/sentinel-<span class=nv>$i</span>.conf <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s># Sentinel 基本配置
</span></span></span><span class=line><span class=cl><span class=s>port $port
</span></span></span><span class=line><span class=cl><span class=s>bind 0.0.0.0
</span></span></span><span class=line><span class=cl><span class=s>protected-mode no
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 工作目录
</span></span></span><span class=line><span class=cl><span class=s>dir /home/$(whoami)/redis-practice/sentinel/data/sentinel-$i
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 日志配置
</span></span></span><span class=line><span class=cl><span class=s>logfile /home/$(whoami)/redis-practice/sentinel/logs/sentinel-$i.log
</span></span></span><span class=line><span class=cl><span class=s>loglevel notice
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 监控主节点配置
</span></span></span><span class=line><span class=cl><span class=s>sentinel monitor mymaster 127.0.0.1 6379 2
</span></span></span><span class=line><span class=cl><span class=s>sentinel auth-pass mymaster redis123
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 故障检测配置
</span></span></span><span class=line><span class=cl><span class=s>sentinel down-after-milliseconds mymaster 5000
</span></span></span><span class=line><span class=cl><span class=s>sentinel parallel-syncs mymaster 1
</span></span></span><span class=line><span class=cl><span class=s>sentinel failover-timeout mymaster 10000
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Sentinel 认证
</span></span></span><span class=line><span class=cl><span class=s>requirepass sentinel123
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 通知脚本 (可选)
</span></span></span><span class=line><span class=cl><span class=s># sentinel notification-script mymaster /path/to/notify.sh
</span></span></span><span class=line><span class=cl><span class=s># sentinel client-reconfig-script mymaster /path/to/reconfig.sh
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    mkdir -p ~/redis-practice/sentinel/data/sentinel-<span class=nv>$i</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=43-启动-sentinel-架构>4.3 启动 Sentinel 架构</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建修复版本的启动脚本</span>
</span></span><span class=line><span class=cl>cat &gt; ~/redis-practice/sentinel/start-sentinel-cluster.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>BASE_DIR=~/redis-practice/sentinel
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#39;=== 检查Redis安装状态 ===&#39;
</span></span></span><span class=line><span class=cl><span class=s># 检查Redis是否安装
</span></span></span><span class=line><span class=cl><span class=s>if ! command -v redis-server &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>    echo &#39;错误: redis-server 命令未找到！&#39;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#39;请先安装Redis:&#39;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#39;  Ubuntu/Debian: sudo apt install redis-server -y&#39;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#39;  CentOS/RHEL: sudo yum install redis -y&#39;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#39;  macOS: brew install redis&#39;
</span></span></span><span class=line><span class=cl><span class=s>    exit 1
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 检查sentinel启动方式
</span></span></span><span class=line><span class=cl><span class=s>SENTINEL_CMD=&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>if command -v redis-sentinel &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>    SENTINEL_CMD=&#39;redis-sentinel&#39;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#39;✅ 使用 redis-sentinel 命令启动哨兵&#39;
</span></span></span><span class=line><span class=cl><span class=s>else
</span></span></span><span class=line><span class=cl><span class=s>    SENTINEL_CMD=&#39;redis-server --sentinel&#39;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#39;⚠️  redis-sentinel 命令不存在，使用 redis-server --sentinel 模式&#39;
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 创建数据目录 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>mkdir -p $BASE_DIR/data/{master,slave1,slave2}
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 启动 Redis 主从节点 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-server $BASE_DIR/conf/redis-master.conf &amp;
</span></span></span><span class=line><span class=cl><span class=s>sleep 2
</span></span></span><span class=line><span class=cl><span class=s>redis-server $BASE_DIR/conf/redis-slave1.conf &amp;
</span></span></span><span class=line><span class=cl><span class=s>redis-server $BASE_DIR/conf/redis-slave2.conf &amp;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 等待主从同步 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>sleep 5
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 验证主从节点启动状态
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 验证主从节点状态 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>for port in 6379 6380 6381; do
</span></span></span><span class=line><span class=cl><span class=s>    if redis-cli -p $port -a redis123 ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;✅ Redis节点 $port 启动成功&#34;
</span></span></span><span class=line><span class=cl><span class=s>    else
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;❌ Redis节点 $port 启动失败&#34;
</span></span></span><span class=line><span class=cl><span class=s>        exit 1
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 启动 Sentinel 哨兵 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>for i in 1 2 3; do
</span></span></span><span class=line><span class=cl><span class=s>    port=$((26378 + i))
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;启动 Sentinel-$i (端口$port)&#34;
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 首先检查命令是否存在，然后启动
</span></span></span><span class=line><span class=cl><span class=s>    if command -v redis-sentinel &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;  使用 redis-sentinel 命令启动&#34;
</span></span></span><span class=line><span class=cl><span class=s>        redis-sentinel $BASE_DIR/conf/sentinel-$i.conf &amp;
</span></span></span><span class=line><span class=cl><span class=s>    elif command -v redis-server &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;  使用 redis-server --sentinel 模式启动&#34;
</span></span></span><span class=line><span class=cl><span class=s>        redis-server $BASE_DIR/conf/sentinel-$i.conf --sentinel &amp;
</span></span></span><span class=line><span class=cl><span class=s>    else
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;  错误: 未找到 redis-sentinel 或 redis-server 命令&#34;
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;  请检查 Redis 是否正确安装&#34;
</span></span></span><span class=line><span class=cl><span class=s>        exit 1
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>    sleep 2
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 验证启动状态
</span></span></span><span class=line><span class=cl><span class=s>    if redis-cli -p $port -a sentinel123 ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;  ✅ Sentinel-$i 启动成功&#34;
</span></span></span><span class=line><span class=cl><span class=s>    else
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;  ⚠️  Sentinel-$i 可能未完全启动，请稍后检查&#34;
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== Sentinel 集群启动完成 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>sleep 3
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 验证Sentinel状态
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 验证 Sentinel 状态 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>for port in 26379 26380 26381; do
</span></span></span><span class=line><span class=cl><span class=s>    if redis-cli -p $port -a sentinel123 ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;✅ Sentinel $port 启动成功&#34;
</span></span></span><span class=line><span class=cl><span class=s>    else
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;⚠️  Sentinel $port 可能未完全启动，请稍等&#34;
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>sleep 2
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 查看 Sentinel 状态 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 26379 -a sentinel123 sentinel masters 2&gt;/dev/null || echo &#34;Sentinel还在初始化中，请稍后手动检查&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/sentinel/start-sentinel-cluster.sh
</span></span></code></pre></td></tr></table></div></div><p>手动启动方案：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 手动启动方案</span>
</span></span><span class=line><span class=cl>cat &gt; ~/redis-practice/sentinel/manual-start-sentinel.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>BASE_DIR=~/redis-practice/sentinel
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 手动启动 Sentinel 架构 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 步骤1: 启动Redis主从节点
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;1. 启动Redis主从节点...&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-server $BASE_DIR/conf/redis-master.conf &amp;
</span></span></span><span class=line><span class=cl><span class=s>sleep 2
</span></span></span><span class=line><span class=cl><span class=s>redis-server $BASE_DIR/conf/redis-slave1.conf &amp;
</span></span></span><span class=line><span class=cl><span class=s>sleep 2
</span></span></span><span class=line><span class=cl><span class=s>redis-server $BASE_DIR/conf/redis-slave2.conf &amp;
</span></span></span><span class=line><span class=cl><span class=s>sleep 3
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 步骤2: 验证主从节点
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;2. 验证主从节点状态...&#34;
</span></span></span><span class=line><span class=cl><span class=s>for port in 6379 6380 6381; do
</span></span></span><span class=line><span class=cl><span class=s>    if redis-cli -p $port -a redis123 ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;  ✅ Redis $port: OK&#34;
</span></span></span><span class=line><span class=cl><span class=s>    else
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;  ❌ Redis $port: 失败&#34;
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 步骤3: 尝试不同的Sentinel启动方式
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;3. 启动Sentinel哨兵...&#34;
</span></span></span><span class=line><span class=cl><span class=s>for i in 1 2 3; do
</span></span></span><span class=line><span class=cl><span class=s>    port=$((26378 + i))
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;  启动 Sentinel-$i (端口$port)&#34;
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 方式1: 检查并使用redis-sentinel
</span></span></span><span class=line><span class=cl><span class=s>    if command -v redis-sentinel &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;    📍 检测到 redis-sentinel 命令，正在启动...&#34;
</span></span></span><span class=line><span class=cl><span class=s>        redis-sentinel $BASE_DIR/conf/sentinel-$i.conf &amp;
</span></span></span><span class=line><span class=cl><span class=s>        sleep 1
</span></span></span><span class=line><span class=cl><span class=s>        # 验证启动是否成功
</span></span></span><span class=line><span class=cl><span class=s>        if redis-cli -p $port -a sentinel123 ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>            echo &#34;    ✅ 使用 redis-sentinel 启动成功&#34;
</span></span></span><span class=line><span class=cl><span class=s>        else
</span></span></span><span class=line><span class=cl><span class=s>            echo &#34;    ❌ redis-sentinel 启动失败&#34;
</span></span></span><span class=line><span class=cl><span class=s>        fi
</span></span></span><span class=line><span class=cl><span class=s>    else
</span></span></span><span class=line><span class=cl><span class=s>        # 方式2: 使用redis-server --sentinel
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;    ⚠️  redis-sentinel 命令不存在，尝试 redis-server --sentinel&#34;
</span></span></span><span class=line><span class=cl><span class=s>        if command -v redis-server &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>            redis-server $BASE_DIR/conf/sentinel-$i.conf --sentinel &amp;
</span></span></span><span class=line><span class=cl><span class=s>            sleep 1
</span></span></span><span class=line><span class=cl><span class=s>            # 验证启动是否成功
</span></span></span><span class=line><span class=cl><span class=s>            if redis-cli -p $port -a sentinel123 ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>                echo &#34;    ✅ 使用 redis-server --sentinel 启动成功&#34;
</span></span></span><span class=line><span class=cl><span class=s>            else
</span></span></span><span class=line><span class=cl><span class=s>                echo &#34;    ❌ redis-server --sentinel 启动失败&#34;
</span></span></span><span class=line><span class=cl><span class=s>            fi
</span></span></span><span class=line><span class=cl><span class=s>        else
</span></span></span><span class=line><span class=cl><span class=s>            echo &#34;    ❌ redis-server 命令也不存在，无法启动 Sentinel&#34;
</span></span></span><span class=line><span class=cl><span class=s>        fi
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>    sleep 2
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>sleep 5
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 步骤4: 验证Sentinel状态
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;4. 验证Sentinel状态...&#34;
</span></span></span><span class=line><span class=cl><span class=s>for port in 26379 26380 26381; do
</span></span></span><span class=line><span class=cl><span class=s>    if redis-cli -p $port -a sentinel123 ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;  ✅ Sentinel $port: OK&#34;
</span></span></span><span class=line><span class=cl><span class=s>    else
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;  ❌ Sentinel $port: 失败&#34;
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 启动完成，运行以下命令检查状态 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;redis-cli -p 26379 -a sentinel123 sentinel masters&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/sentinel/manual-start-sentinel.sh
</span></span></code></pre></td></tr></table></div></div><h3 id=44-验证-sentinel-功能>4.4 验证 Sentinel 功能</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建 Sentinel 测试脚本</span>
</span></span><span class=line><span class=cl>cat &gt; ~/redis-practice/sentinel/test-sentinel.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>SENTINEL_PASSWORD=&#34;sentinel123&#34;
</span></span></span><span class=line><span class=cl><span class=s>REDIS_PASSWORD=&#34;redis123&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== 1. 查看当前主节点 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 26379 -a $SENTINEL_PASSWORD sentinel get-master-addr-by-name mymaster
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n=== 2. 查看所有监控的主节点 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 26379 -a $SENTINEL_PASSWORD sentinel masters
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n=== 3. 查看从节点信息 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 26379 -a $SENTINEL_PASSWORD sentinel slaves mymaster
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n=== 4. 查看其他 Sentinel 节点 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 26379 -a $SENTINEL_PASSWORD sentinel sentinels mymaster
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n=== 5. 测试数据写入主节点 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 6379 -a $REDIS_PASSWORD set sentinel-test &#34;Hello Sentinel&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n=== 6. 从从节点读取数据 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 6380 -a $REDIS_PASSWORD get sentinel-test
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 6381 -a $REDIS_PASSWORD get sentinel-test
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n=== 7. 模拟主节点故障 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;将要关闭主节点 (端口 6379)，观察 Sentinel 的故障转移...&#34;
</span></span></span><span class=line><span class=cl><span class=s>read -p &#34;按 Enter 继续...&#34; 
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 6379 -a $REDIS_PASSWORD debug segfault || redis-cli -p 6379 -a $REDIS_PASSWORD shutdown
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n=== 8. 等待故障转移完成 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>sleep 10
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n=== 9. 查看新的主节点 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -p 26379 -a $SENTINEL_PASSWORD sentinel get-master-addr-by-name mymaster
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n=== 10. 验证新主节点可写入 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>NEW_MASTER=$(redis-cli -p 26379 -a $SENTINEL_PASSWORD sentinel get-master-addr-by-name mymaster | head -1)
</span></span></span><span class=line><span class=cl><span class=s>NEW_PORT=$(redis-cli -p 26379 -a $SENTINEL_PASSWORD sentinel get-master-addr-by-name mymaster | tail -1)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -h $NEW_MASTER -p $NEW_PORT -a $REDIS_PASSWORD set failover-test &#34;Master switched successfully&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -h $NEW_MASTER -p $NEW_PORT -a $REDIS_PASSWORD get failover-test
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/sentinel/test-sentinel.sh
</span></span><span class=line><span class=cl>~/redis-practice/sentinel/test-sentinel.sh
</span></span></code></pre></td></tr></table></div></div><h2 id=5-监控和管理工具>5 监控和管理工具</h2><h3 id=51-redis-核心监控命令详解>5.1 Redis 核心监控命令详解</h3><p>在编写监控脚本之前，让我们先了解 Redis 的核心监控命令：</p><h4 id=系统信息查询命令>系统信息查询命令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 基本信息查询</span>
</span></span><span class=line><span class=cl>INFO                                 <span class=c1># 获取所有服务器信息</span>
</span></span><span class=line><span class=cl>INFO server                          <span class=c1># 服务器基本信息</span>
</span></span><span class=line><span class=cl>INFO memory                          <span class=c1># 内存使用信息</span>
</span></span><span class=line><span class=cl>INFO replication                     <span class=c1># 复制相关信息</span>
</span></span><span class=line><span class=cl>INFO persistence                     <span class=c1># 持久化信息</span>
</span></span><span class=line><span class=cl>INFO stats                           <span class=c1># 统计信息</span>
</span></span><span class=line><span class=cl>INFO clients                         <span class=c1># 客户端连接信息</span>
</span></span><span class=line><span class=cl>INFO cpu                             <span class=c1># CPU 使用信息</span>
</span></span><span class=line><span class=cl>INFO cluster                         <span class=c1># 集群信息</span>
</span></span><span class=line><span class=cl>INFO keyspace                        <span class=c1># 键空间信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 性能监控命令</span>
</span></span><span class=line><span class=cl>MONITOR                              <span class=c1># 实时监控所有命令</span>
</span></span><span class=line><span class=cl>SLOWLOG GET <span class=o>[</span>count<span class=o>]</span>                  <span class=c1># 获取慢查询日志</span>
</span></span><span class=line><span class=cl>SLOWLOG LEN                          <span class=c1># 获取慢查询日志长度</span>
</span></span><span class=line><span class=cl>SLOWLOG RESET                        <span class=c1># 清空慢查询日志</span>
</span></span><span class=line><span class=cl>CLIENT LIST                          <span class=c1># 列出所有客户端连接</span>
</span></span><span class=line><span class=cl>CLIENT KILL <span class=o>[</span>ip:port<span class=o>]</span>                <span class=c1># 杀死指定客户端连接</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 内存分析命令</span>
</span></span><span class=line><span class=cl>MEMORY USAGE &lt;key&gt;                   <span class=c1># 查看键的内存使用量</span>
</span></span><span class=line><span class=cl>MEMORY STATS                         <span class=c1># 内存统计信息</span>
</span></span><span class=line><span class=cl>MEMORY DOCTOR                        <span class=c1># 内存诊断建议</span>
</span></span><span class=line><span class=cl>DBSIZE                               <span class=c1># 当前数据库键的数量</span>
</span></span><span class=line><span class=cl>LASTSAVE                             <span class=c1># 最后一次保存到磁盘的时间</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 配置管理命令</span>
</span></span><span class=line><span class=cl>CONFIG GET &lt;parameter&gt;               <span class=c1># 获取配置参数</span>
</span></span><span class=line><span class=cl>CONFIG SET &lt;parameter&gt; &lt;value&gt;       <span class=c1># 设置配置参数</span>
</span></span><span class=line><span class=cl>CONFIG REWRITE                       <span class=c1># 将配置写入配置文件</span>
</span></span><span class=line><span class=cl>CONFIG RESETSTAT                     <span class=c1># 重置统计信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 数据库操作命令</span>
</span></span><span class=line><span class=cl>SELECT &lt;db&gt;                          <span class=c1># 选择数据库</span>
</span></span><span class=line><span class=cl>FLUSHDB                              <span class=c1># 清空当前数据库</span>
</span></span><span class=line><span class=cl>FLUSHALL                             <span class=c1># 清空所有数据库</span>
</span></span><span class=line><span class=cl>SAVE                                 <span class=c1># 同步保存数据到磁盘</span>
</span></span><span class=line><span class=cl>BGSAVE                               <span class=c1># 异步保存数据到磁盘</span>
</span></span><span class=line><span class=cl>BGREWRITEAOF                         <span class=c1># 异步重写AOF文件</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=实用监控脚本示例>实用监控脚本示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建综合监控脚本</span>
</span></span><span class=line><span class=cl>cat &gt; ~/redis-practice/redis-health-check.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 单个Redis实例健康检查函数
</span></span></span><span class=line><span class=cl><span class=s>check_redis_health() {
</span></span></span><span class=line><span class=cl><span class=s>    local host=$1
</span></span></span><span class=line><span class=cl><span class=s>    local port=$2
</span></span></span><span class=line><span class=cl><span class=s>    local password=$3
</span></span></span><span class=line><span class=cl><span class=s>    local name=$4
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;=== $name 健康检查 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 连接测试
</span></span></span><span class=line><span class=cl><span class=s>    if ! redis-cli -h $host -p $port -a $password ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;❌ 连接失败&#34;
</span></span></span><span class=line><span class=cl><span class=s>        return 1
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 获取详细信息
</span></span></span><span class=line><span class=cl><span class=s>    local info=$(redis-cli -h $host -p $port -a $password info 2&gt;/dev/null)
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 基本信息
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;Redis版本: $(echo &#34;$info&#34; | grep redis_version | cut -d: -f2 | tr -d &#39;\r&#39;)&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;运行模式: $(echo &#34;$info&#34; | grep redis_mode | cut -d: -f2 | tr -d &#39;\r&#39;)&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;进程ID: $(echo &#34;$info&#34; | grep process_id | cut -d: -f2 | tr -d &#39;\r&#39;)&#34;
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 运行时间
</span></span></span><span class=line><span class=cl><span class=s>    local uptime=$(echo &#34;$info&#34; | grep uptime_in_seconds | cut -d: -f2 | tr -d &#39;\r&#39;)
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;运行时间: $((uptime/3600))小时 $(((uptime%3600)/60))分钟&#34;
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 内存使用
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;内存使用: $(echo &#34;$info&#34; | grep used_memory_human | cut -d: -f2 | tr -d &#39;\r&#39;)&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;内存峰值: $(echo &#34;$info&#34; | grep used_memory_peak_human | cut -d: -f2 | tr -d &#39;\r&#39;)&#34;
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 连接数
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;连接客户端: $(echo &#34;$info&#34; | grep connected_clients | cut -d: -f2 | tr -d &#39;\r&#39;)&#34;
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 命令统计
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;总命令数: $(echo &#34;$info&#34; | grep total_commands_processed | cut -d: -f2 | tr -d &#39;\r&#39;)&#34;
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 键空间信息
</span></span></span><span class=line><span class=cl><span class=s>    local keyspace=$(echo &#34;$info&#34; | grep &#34;^db0:&#34; | cut -d: -f2 | tr -d &#39;\r&#39;)
</span></span></span><span class=line><span class=cl><span class=s>    if [ ! -z &#34;$keyspace&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;数据库0: $keyspace&#34;
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 持久化状态
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;上次保存: $(date -d @$(echo &#34;$info&#34; | grep rdb_last_save_time | cut -d: -f2 | tr -d &#39;\r&#39;))&#34;
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 复制状态（如果是主从架构）
</span></span></span><span class=line><span class=cl><span class=s>    local role=$(echo &#34;$info&#34; | grep &#34;role:&#34; | cut -d: -f2 | tr -d &#39;\r&#39;)
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;节点角色: $role&#34;
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    if [ &#34;$role&#34; = &#34;master&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>        local slaves=$(echo &#34;$info&#34; | grep connected_slaves | cut -d: -f2 | tr -d &#39;\r&#39;)
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;连接从节点: $slaves&#34;
</span></span></span><span class=line><span class=cl><span class=s>    elif [ &#34;$role&#34; = &#34;slave&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s>        local master_link=$(echo &#34;$info&#34; | grep master_link_status | cut -d: -f2 | tr -d &#39;\r&#39;)
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;主节点连接: $master_link&#34;
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 慢查询检查
</span></span></span><span class=line><span class=cl><span class=s>    local slow_queries=$(redis-cli -h $host -p $port -a $password slowlog len 2&gt;/dev/null)
</span></span></span><span class=line><span class=cl><span class=s>    if [ &#34;$slow_queries&#34; -gt 0 ]; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;⚠️  慢查询: $slow_queries 条&#34;
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;✅ 健康检查完成&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/redis-health-check.sh
</span></span></code></pre></td></tr></table></div></div><h3 id=52-redis-监控脚本>5.2 Redis 监控脚本</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; ~/redis-practice/redis-monitor.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>monitor_redis() {
</span></span></span><span class=line><span class=cl><span class=s>    local host=$1
</span></span></span><span class=line><span class=cl><span class=s>    local port=$2
</span></span></span><span class=line><span class=cl><span class=s>    local password=$3
</span></span></span><span class=line><span class=cl><span class=s>    local name=$4
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;=== $name ($host:$port) ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    # 检查连接
</span></span></span><span class=line><span class=cl><span class=s>    if redis-cli -h $host -p $port -a $password ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;✅ 连接状态: 正常&#34;
</span></span></span><span class=line><span class=cl><span class=s>        
</span></span></span><span class=line><span class=cl><span class=s>        # 获取基本信息
</span></span></span><span class=line><span class=cl><span class=s>        info=$(redis-cli -h $host -p $port -a $password info server,memory,clients 2&gt;/dev/null)
</span></span></span><span class=line><span class=cl><span class=s>        
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;Redis 版本: $(echo &#34;$info&#34; | grep redis_version | cut -d: -f2 | tr -d &#39;\r&#39;)&#34;
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;运行时间: $(echo &#34;$info&#34; | grep uptime_in_seconds | cut -d: -f2 | tr -d &#39;\r&#39;) 秒&#34;
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;内存使用: $(echo &#34;$info&#34; | grep used_memory_human | cut -d: -f2 | tr -d &#39;\r&#39;)&#34;
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;连接客户端: $(echo &#34;$info&#34; | grep connected_clients | cut -d: -f2 | tr -d &#39;\r&#39;)&#34;
</span></span></span><span class=line><span class=cl><span class=s>        
</span></span></span><span class=line><span class=cl><span class=s>        # 检查角色
</span></span></span><span class=line><span class=cl><span class=s>        role=$(redis-cli -h $host -p $port -a $password info replication 2&gt;/dev/null | grep &#34;role:&#34; | cut -d: -f2 | tr -d &#39;\r&#39;)
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;节点角色: $role&#34;
</span></span></span><span class=line><span class=cl><span class=s>        
</span></span></span><span class=line><span class=cl><span class=s>    else
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;❌ 连接状态: 失败&#34;
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;Redis 架构监控报告&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;====================&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;生成时间: $(date)&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;1. 主从架构监控&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;----------------&#34;
</span></span></span><span class=line><span class=cl><span class=s>monitor_redis 127.0.0.1 6379 redis123 &#34;主节点&#34;
</span></span></span><span class=line><span class=cl><span class=s>monitor_redis 127.0.0.1 6380 redis123 &#34;从节点1&#34;
</span></span></span><span class=line><span class=cl><span class=s>monitor_redis 127.0.0.1 6381 redis123 &#34;从节点2&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;2. 集群架构监控&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;----------------&#34;
</span></span></span><span class=line><span class=cl><span class=s>for port in 7000 7001 7002 7003 7004 7005; do
</span></span></span><span class=line><span class=cl><span class=s>    monitor_redis 127.0.0.1 $port redis123 &#34;集群节点-$port&#34;
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;3. Sentinel 监控&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;----------------&#34;
</span></span></span><span class=line><span class=cl><span class=s>for port in 26379 26380 26381; do
</span></span></span><span class=line><span class=cl><span class=s>    if redis-cli -p $port -a sentinel123 ping &gt;/dev/null 2&gt;&amp;1; then
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;✅ Sentinel-$port: 正常运行&#34;
</span></span></span><span class=line><span class=cl><span class=s>        masters=$(redis-cli -p $port -a sentinel123 sentinel masters 2&gt;/dev/null | grep -c &#34;name&#34;)
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;   监控主节点数: $masters&#34;
</span></span></span><span class=line><span class=cl><span class=s>    else
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;❌ Sentinel-$port: 连接失败&#34;
</span></span></span><span class=line><span class=cl><span class=s>    fi
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/redis-monitor.sh
</span></span></code></pre></td></tr></table></div></div><h3 id=53-清理脚本>5.3 清理脚本</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; ~/redis-practice/cleanup.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== Redis 架构练习清理脚本 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;正在停止所有 Redis 进程...&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 停止 Redis 实例
</span></span></span><span class=line><span class=cl><span class=s>for port in 6379 6380 6381 7000 7001 7002 7003 7004 7005; do
</span></span></span><span class=line><span class=cl><span class=s>    redis-cli -p $port -a redis123 shutdown 2&gt;/dev/null || true
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 停止 Sentinel 实例
</span></span></span><span class=line><span class=cl><span class=s>for port in 26379 26380 26381; do
</span></span></span><span class=line><span class=cl><span class=s>    redis-cli -p $port -a sentinel123 shutdown 2&gt;/dev/null || true
</span></span></span><span class=line><span class=cl><span class=s>done
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 强制杀死可能残留的进程
</span></span></span><span class=line><span class=cl><span class=s>pkill -f redis-server 2&gt;/dev/null || true
</span></span></span><span class=line><span class=cl><span class=s>pkill -f redis-sentinel 2&gt;/dev/null || true
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;正在清理数据文件...&#34;
</span></span></span><span class=line><span class=cl><span class=s>rm -rf ~/redis-practice/*/data/*
</span></span></span><span class=line><span class=cl><span class=s>rm -rf ~/redis-practice/*/logs/*
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;清理完成！&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;如需重新开始，请重新运行相应的启动脚本。&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/cleanup.sh
</span></span></code></pre></td></tr></table></div></div><h2 id=6-性能测试>6 性能测试</h2><h3 id=61-redis-性能测试核心命令>6.1 Redis 性能测试核心命令</h3><p>在使用性能测试脚本之前，让我们先了解 redis-benchmark 的核心参数：</p><h4 id=redis-benchmark-命令详解>redis-benchmark 命令详解</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 基本用法</span>
</span></span><span class=line><span class=cl>redis-benchmark <span class=o>[</span>options<span class=o>]</span>            <span class=c1># 基本命令格式</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 连接相关参数</span>
</span></span><span class=line><span class=cl>-h &lt;hostname&gt;                        <span class=c1># Redis服务器地址（默认127.0.0.1）</span>
</span></span><span class=line><span class=cl>-p &lt;port&gt;                            <span class=c1># Redis服务器端口（默认6379）</span>
</span></span><span class=line><span class=cl>-a &lt;password&gt;                        <span class=c1># Redis密码</span>
</span></span><span class=line><span class=cl>-s &lt;socket&gt;                          <span class=c1># Unix socket连接</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 测试参数</span>
</span></span><span class=line><span class=cl>-c &lt;clients&gt;                         <span class=c1># 并发客户端数量（默认50）</span>
</span></span><span class=line><span class=cl>-n &lt;requests&gt;                        <span class=c1># 总请求数（默认10000）</span>
</span></span><span class=line><span class=cl>-d &lt;size&gt;                            <span class=c1># 数据大小（字节，默认3）</span>
</span></span><span class=line><span class=cl>-t &lt;tests&gt;                           <span class=c1># 指定要测试的命令（用逗号分隔）</span>
</span></span><span class=line><span class=cl>-r &lt;keyspacelen&gt;                     <span class=c1># 使用随机键，指定键空间大小</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 输出格式</span>
</span></span><span class=line><span class=cl>--csv                                <span class=c1># CSV格式输出</span>
</span></span><span class=line><span class=cl>-q                                   <span class=c1># 简化输出</span>
</span></span><span class=line><span class=cl>--latency                            <span class=c1># 延迟相关统计</span>
</span></span><span class=line><span class=cl>--latency-history                    <span class=c1># 延迟历史记录</span>
</span></span><span class=line><span class=cl>--latency-dist                       <span class=c1># 延迟分布统计</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 特殊选项</span>
</span></span><span class=line><span class=cl>-i &lt;interval&gt;                        <span class=c1># 间隔时间（秒）</span>
</span></span><span class=line><span class=cl>-l                                   <span class=c1># 循环测试</span>
</span></span><span class=line><span class=cl>-P &lt;pipeline&gt;                        <span class=c1># 使用管道模式</span>
</span></span><span class=line><span class=cl>--cluster                            <span class=c1># 集群模式</span>
</span></span><span class=line><span class=cl>-e                                   <span class=c1># 在错误时显示错误信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 常用测试命令</span>
</span></span><span class=line><span class=cl>SET                                  <span class=c1># 设置键值</span>
</span></span><span class=line><span class=cl>GET                                  <span class=c1># 获取键值</span>
</span></span><span class=line><span class=cl>INCR                                 <span class=c1># 递增</span>
</span></span><span class=line><span class=cl>LPUSH                                <span class=c1># 列表推入</span>
</span></span><span class=line><span class=cl>RPUSH                                <span class=c1># 列表推入</span>
</span></span><span class=line><span class=cl>LPOP                                 <span class=c1># 列表弹出</span>
</span></span><span class=line><span class=cl>RPOP                                 <span class=c1># 列表弹出</span>
</span></span><span class=line><span class=cl>SADD                                 <span class=c1># 集合添加</span>
</span></span><span class=line><span class=cl>HSET                                 <span class=c1># 哈希设置</span>
</span></span><span class=line><span class=cl>SPOP                                 <span class=c1># 集合弹出</span>
</span></span><span class=line><span class=cl>ZADD                                 <span class=c1># 有序集合添加</span>
</span></span><span class=line><span class=cl>ZREVRANGE                            <span class=c1># 有序集合范围查询</span>
</span></span><span class=line><span class=cl>MSET                                 <span class=c1># 批量设置</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=实用性能测试示例>实用性能测试示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 基本性能测试</span>
</span></span><span class=line><span class=cl>redis-benchmark -h 127.0.0.1 -p <span class=m>6379</span> -a redis123 -c <span class=m>50</span> -n <span class=m>10000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 指定命令测试</span>
</span></span><span class=line><span class=cl>redis-benchmark -h 127.0.0.1 -p <span class=m>6379</span> -a redis123 -t set,get -n <span class=m>100000</span> -c <span class=m>100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 不同数据大小测试</span>
</span></span><span class=line><span class=cl>redis-benchmark -h 127.0.0.1 -p <span class=m>6379</span> -a redis123 -t set,get -n <span class=m>10000</span> -d <span class=m>1024</span> -c <span class=m>50</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 管道模式测试</span>
</span></span><span class=line><span class=cl>redis-benchmark -h 127.0.0.1 -p <span class=m>6379</span> -a redis123 -t set,get -n <span class=m>10000</span> -P <span class=m>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 随机键测试</span>
</span></span><span class=line><span class=cl>redis-benchmark -h 127.0.0.1 -p <span class=m>6379</span> -a redis123 -t set,get -n <span class=m>10000</span> -r <span class=m>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 集群模式测试</span>
</span></span><span class=line><span class=cl>redis-benchmark -h 127.0.0.1 -p <span class=m>7000</span> -a redis123 -t set,get -n <span class=m>10000</span> --cluster
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7. 延迟测试</span>
</span></span><span class=line><span class=cl>redis-cli -h 127.0.0.1 -p <span class=m>6379</span> -a redis123 --latency
</span></span><span class=line><span class=cl>redis-cli -h 127.0.0.1 -p <span class=m>6379</span> -a redis123 --latency-history -i <span class=m>1</span>
</span></span><span class=line><span class=cl>redis-cli -h 127.0.0.1 -p <span class=m>6379</span> -a redis123 --latency-dist
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 8. 内存使用分析</span>
</span></span><span class=line><span class=cl>redis-cli -h 127.0.0.1 -p <span class=m>6379</span> -a redis123 --bigkeys
</span></span><span class=line><span class=cl>redis-cli -h 127.0.0.1 -p <span class=m>6379</span> -a redis123 --hotkeys  <span class=c1># 需要开启 maxmemory-policy</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 9. 综合性能分析</span>
</span></span><span class=line><span class=cl>redis-benchmark -h 127.0.0.1 -p <span class=m>6379</span> -a redis123 -t set,get,incr,lpush,rpush,lpop,rpop,sadd,hset,spop,zadd,zrevrange,mset -n <span class=m>100000</span> -c <span class=m>50</span> --csv
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 10. 对比测试脚本</span>
</span></span><span class=line><span class=cl>cat &gt; ~/redis-practice/performance-compare.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;Redis 性能对比测试&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;====================&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 测试参数
</span></span></span><span class=line><span class=cl><span class=s>TEST_COUNT=50000
</span></span></span><span class=line><span class=cl><span class=s>CONCURRENCY=50
</span></span></span><span class=line><span class=cl><span class=s>DATA_SIZE=100
</span></span></span><span class=line><span class=cl><span class=s>PASSWORD=&#34;redis123&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 测试单机Redis
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;1. 单机 Redis 性能测试 (6379)&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;--------------------------------&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-benchmark -h 127.0.0.1 -p 6379 -a $PASSWORD -t set,get -n $TEST_COUNT -c $CONCURRENCY -d $DATA_SIZE -q
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 测试从节点读性能
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n2. 从节点读性能测试 (6380)&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;--------------------------------&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-benchmark -h 127.0.0.1 -p 6380 -a $PASSWORD -t get -n $TEST_COUNT -c $CONCURRENCY -d $DATA_SIZE -q
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 测试集群性能
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n3. 集群模式性能测试 (7000)&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;--------------------------------&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-benchmark -h 127.0.0.1 -p 7000 -a $PASSWORD -t set,get -n $TEST_COUNT -c $CONCURRENCY -d $DATA_SIZE --cluster -q 2&gt;/dev/null
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 管道模式测试
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n4. 管道模式性能测试&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;--------------------------------&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-benchmark -h 127.0.0.1 -p 6379 -a $PASSWORD -t set,get -n $TEST_COUNT -c $CONCURRENCY -d $DATA_SIZE -P 10 -q
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo -e &#34;\n测试完成！&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/performance-compare.sh
</span></span></code></pre></td></tr></table></div></div><h3 id=62-基准测试脚本>6.2 基准测试脚本</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; ~/redis-practice/benchmark.sh <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;=== Redis 性能测试 ===&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>test_single() {
</span></span></span><span class=line><span class=cl><span class=s>    local host=$1
</span></span></span><span class=line><span class=cl><span class=s>    local port=$2
</span></span></span><span class=line><span class=cl><span class=s>    local password=$3
</span></span></span><span class=line><span class=cl><span class=s>    local name=$4
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;测试 $name ($host:$port)&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;------------------------&#34;
</span></span></span><span class=line><span class=cl><span class=s>    
</span></span></span><span class=line><span class=cl><span class=s>    redis-benchmark -h $host -p $port -a $password -t set,get -n 10000 -c 50 -d 100 --csv | \
</span></span></span><span class=line><span class=cl><span class=s>    while IFS=, read test ops_per_sec; do
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;$test: $ops_per_sec 操作/秒&#34;
</span></span></span><span class=line><span class=cl><span class=s>    done
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>test_cluster() {
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;测试 Redis 集群&#34;
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;----------------&#34;
</span></span></span><span class=line><span class=cl><span class=s>    redis-benchmark -h 127.0.0.1 -p 7000 -a redis123 -t set,get -n 10000 -c 50 -d 100 --cluster --csv | \
</span></span></span><span class=line><span class=cl><span class=s>    while IFS=, read test ops_per_sec; do
</span></span></span><span class=line><span class=cl><span class=s>        echo &#34;$test: $ops_per_sec 操作/秒&#34;
</span></span></span><span class=line><span class=cl><span class=s>    done
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;1. 单实例性能测试&#34;
</span></span></span><span class=line><span class=cl><span class=s>test_single 127.0.0.1 6379 redis123 &#34;主节点&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;2. 集群性能测试&#34;
</span></span></span><span class=line><span class=cl><span class=s>test_cluster
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;3. 延迟测试&#34;
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;------------&#34;
</span></span></span><span class=line><span class=cl><span class=s>redis-cli -h 127.0.0.1 -p 6379 -a redis123 --latency -i 1 &amp;
</span></span></span><span class=line><span class=cl><span class=s>LATENCY_PID=$!
</span></span></span><span class=line><span class=cl><span class=s>sleep 5
</span></span></span><span class=line><span class=cl><span class=s>kill $LATENCY_PID
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x ~/redis-practice/benchmark.sh
</span></span></code></pre></td></tr></table></div></div><h2 id=7-快速操作命令总结>7 快速操作命令总结</h2><h3 id=71-核心命令速查表>7.1 核心命令速查表</h3><h4 id=redis-基础管理命令>Redis 基础管理命令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 启动和连接</span>
</span></span><span class=line><span class=cl>redis-server <span class=o>[</span>config_file<span class=o>]</span>           <span class=c1># 启动Redis服务器</span>
</span></span><span class=line><span class=cl>redis-cli -h host -p port -a password <span class=c1># 连接Redis</span>
</span></span><span class=line><span class=cl>redis-cli --cluster create ...       <span class=c1># 创建集群</span>
</span></span><span class=line><span class=cl>redis-sentinel sentinel.conf         <span class=c1># 启动Sentinel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 信息查询</span>
</span></span><span class=line><span class=cl>INFO <span class=o>[</span>section<span class=o>]</span>                       <span class=c1># 获取服务器信息</span>
</span></span><span class=line><span class=cl>PING                                 <span class=c1># 测试连接</span>
</span></span><span class=line><span class=cl>DBSIZE                               <span class=c1># 获取键数量</span>
</span></span><span class=line><span class=cl>CONFIG GET parameter                 <span class=c1># 获取配置</span>
</span></span><span class=line><span class=cl>SLOWLOG GET <span class=o>[</span>count<span class=o>]</span>                  <span class=c1># 获取慢查询日志</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 主从复制</span>
</span></span><span class=line><span class=cl>REPLICAOF host port                  <span class=c1># 设置主从关系（Redis 5.0+）</span>
</span></span><span class=line><span class=cl>SLAVEOF host port                    <span class=c1># 设置主从关系（Redis 4.x）</span>
</span></span><span class=line><span class=cl>SLAVEOF NO ONE                       <span class=c1># 取消主从关系</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 集群管理</span>
</span></span><span class=line><span class=cl>CLUSTER NODES                        <span class=c1># 查看集群节点</span>
</span></span><span class=line><span class=cl>CLUSTER INFO                         <span class=c1># 查看集群状态</span>
</span></span><span class=line><span class=cl>CLUSTER MEET ip port                 <span class=c1># 加入节点到集群</span>
</span></span><span class=line><span class=cl>CLUSTER ADDSLOTS slot...             <span class=c1># 分配槽位</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sentinel 管理</span>
</span></span><span class=line><span class=cl>SENTINEL MASTERS                     <span class=c1># 查看监控的主节点</span>
</span></span><span class=line><span class=cl>SENTINEL GET-MASTER-ADDR-BY-NAME name <span class=c1># 获取主节点地址</span>
</span></span><span class=line><span class=cl>SENTINEL FAILOVER name               <span class=c1># 手动故障转移</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 性能测试</span>
</span></span><span class=line><span class=cl>redis-benchmark -h host -p port -a password -t tests -n requests -c clients
</span></span></code></pre></td></tr></table></div></div><h3 id=72-实用命令速查手册>7.2 实用命令速查手册</h3><h4 id=日常运维命令>日常运维命令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 服务状态检查</span>
</span></span><span class=line><span class=cl>ps aux <span class=p>|</span> grep redis                  <span class=c1># 查看Redis进程</span>
</span></span><span class=line><span class=cl>netstat -tlnp <span class=p>|</span> grep redis           <span class=c1># 查看Redis端口</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password ping  <span class=c1># 测试连接</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 数据备份和恢复</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password SAVE        <span class=c1># 同步备份</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password BGSAVE      <span class=c1># 异步备份</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password BGREWRITEAOF <span class=c1># 重写AOF</span>
</span></span><span class=line><span class=cl>cp /path/to/dump.rdb /backup/location     <span class=c1># 备份数据文件</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 内存管理</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password MEMORY USAGE key     <span class=c1># 查看键内存使用</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password --bigkeys            <span class=c1># 查找大键</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password FLUSHDB              <span class=c1># 清空当前数据库</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password FLUSHALL             <span class=c1># 清空所有数据库</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 客户端管理</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password CLIENT LIST          <span class=c1># 列出所有客户端</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password CLIENT KILL ip:port  <span class=c1># 关闭指定客户端</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password MONITOR              <span class=c1># 监控所有命令</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 配置管理</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password CONFIG GET <span class=s1>&#39;*&#39;</span>       <span class=c1># 获取所有配置</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password CONFIG SET parameter value  <span class=c1># 设置配置</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password CONFIG REWRITE       <span class=c1># 保存配置到文件</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 性能监控</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password --latency           <span class=c1># 延迟监控</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password --stat              <span class=c1># 实时统计</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password --scan --pattern <span class=s1>&#39;user:*&#39;</span>  <span class=c1># 扫描匹配键</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=故障排查命令>故障排查命令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 日志分析</span>
</span></span><span class=line><span class=cl>tail -f /path/to/redis.log              <span class=c1># 实时查看日志</span>
</span></span><span class=line><span class=cl>grep ERROR /path/to/redis.log           <span class=c1># 查找错误日志</span>
</span></span><span class=line><span class=cl>grep WARNING /path/to/redis.log         <span class=c1># 查找警告日志</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 连接问题排查</span>
</span></span><span class=line><span class=cl>telnet 127.0.0.1 <span class=m>6379</span>                  <span class=c1># 测试TCP连接</span>
</span></span><span class=line><span class=cl>redis-cli -h host -p port ping          <span class=c1># 测试Redis连接</span>
</span></span><span class=line><span class=cl>nmap -p <span class=m>6379</span> host                       <span class=c1># 测试端口开放</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 内存问题排查</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password INFO memory        <span class=c1># 内存使用情况</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password MEMORY DOCTOR      <span class=c1># 内存诊断</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password --bigkeys          <span class=c1># 查找大键</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 性能问题排查</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password SLOWLOG GET <span class=m>10</span>     <span class=c1># 查看慢查询</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password --latency-history  <span class=c1># 延迟历史</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password INFO stats         <span class=c1># 统计信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 主从同步问题</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a password INFO replication   <span class=c1># 主节点复制信息</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6380</span> -a password INFO replication   <span class=c1># 从节点复制信息</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6380</span> -a password REPLICAOF 127.0.0.1 <span class=m>6379</span>  <span class=c1># 重新建立主从关系</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 集群问题排查</span>
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a password CLUSTER NODES   <span class=c1># 集群节点状态</span>
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a password CLUSTER INFO    <span class=c1># 集群整体状态</span>
</span></span><span class=line><span class=cl>redis-cli --cluster check 127.0.0.1:7000 -a password  <span class=c1># 集群健康检查</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=8-学习要点和最佳实践>8 学习要点和最佳实践</h2><h3 id=81-主从复制架构>8.1 主从复制架构</h3><ul><li><strong>优势</strong>: 读写分离，提高读性能</li><li><strong>劣势</strong>: 主节点单点故障，需手动切换</li><li><strong>适用场景</strong>: 读多写少的应用</li></ul><h3 id=82-cluster-集群架构>8.2 Cluster 集群架构</h3><ul><li><strong>优势</strong>: 水平扩展，自动分片，高可用</li><li><strong>劣势</strong>: 复杂性高，某些命令限制</li><li><strong>适用场景</strong>: 大数据量，高并发应用</li></ul><h3 id=83-sentinel-哨兵架构>8.3 Sentinel 哨兵架构</h3><ul><li><strong>优势</strong>: 自动故障转移，监控报警</li><li><strong>劣势</strong>: 额外的运维复杂性</li><li><strong>适用场景</strong>: 对可用性要求高的应用</li></ul><h3 id=84-配置要点>8.4 配置要点</h3><ul><li>密码认证：生产环境必须配置</li><li>持久化：根据业务需求选择 RDB 或 AOF</li><li>内存管理：设置合适的最大内存和淘汰策略</li><li>网络安全：绑定合适的网络接口</li></ul><h3 id=85-常见问题解决方案>8.5 常见问题解决方案</h3><h4 id=问题-connection-refused>问题: &ldquo;Connection refused&rdquo;</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 检查端口占用</span>
</span></span><span class=line><span class=cl>netstat -tlnp <span class=p>|</span> grep :6379
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检查防火墙</span>
</span></span><span class=line><span class=cl>sudo ufw status  <span class=c1># Ubuntu</span>
</span></span><span class=line><span class=cl>sudo firewall-cmd --list-ports  <span class=c1># CentOS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检查Redis进程</span>
</span></span><span class=line><span class=cl>ps aux <span class=p>|</span> grep redis
</span></span></code></pre></td></tr></table></div></div><h4 id=问题-noauth-authentication-required>问题: &ldquo;NOAUTH Authentication required&rdquo;</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 检查密码配置</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>6379</span> -a redis123 ping
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>26379</span> -a sentinel123 ping
</span></span></code></pre></td></tr></table></div></div><h4 id=问题-集群节点无法通信>问题: &ldquo;集群节点无法通信&rdquo;</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 检查集群端口</span>
</span></span><span class=line><span class=cl><span class=k>for</span> port in <span class=m>7000</span> <span class=m>7001</span> <span class=m>7002</span> <span class=m>7003</span> <span class=m>7004</span> 7005<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    redis-cli -p <span class=nv>$port</span> -a redis123 ping
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检查集群状态</span>
</span></span><span class=line><span class=cl>redis-cli -c -p <span class=m>7000</span> -a redis123 cluster nodes
</span></span></code></pre></td></tr></table></div></div><h3 id=86-监控指标>8.6 监控指标</h3><ul><li>内存使用率</li><li>连接数</li><li>命令执行延迟</li><li>主从同步延迟</li><li>集群槽位分布</li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>Chen Guixian</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2025-09-20</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/redis/>Redis</a></div><nav class=post-nav><a class=prev href=/post/ai/vibe-coding-zero-code-to-product-process/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">Vibe Coding：零代码基础实现从想法到产品</span>
<span class="prev-text nav-mobile">上一篇</span>
</a><a class=next href=/post/ai/claude-code-vibe-coding-programming-practice-summary/><span class="next-text nav-default">一个半月高强度 Claude Code ：Vibe coding 是一种全新的思维模式</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动
</span><span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a>
</span><span class=copyright-year>&copy;
2017 -
2025<span class=heart><i class="iconfont icon-heart"></i></span><span>Chen Guixian</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-T2MFM23ZJM"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-T2MFM23ZJM")}</script></body></html>